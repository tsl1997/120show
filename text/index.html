<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniVerse Protocol | è·¨é“¾å­˜è¯ä¸­å¿ƒ v5.4</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .view-section { display: none; }
        .view-active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-link-active { background: #4f46e5 !important; color: white !important; }
        .tag-tempo { background: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe; }
        .tag-somnia { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .tag-sepolia { background: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
        .text-tempo { color: #4338ca; }
        .text-somnia { color: #059669; }
        .text-sepolia { color: #d97706; }
        .card-tempo { border-left: 5px solid #4338ca; }
        .card-somnia { border-left: 5px solid #059669; }
        .card-sepolia { border-left: 5px solid #d97706; }
        .pagination-btn { background: white; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 12px; }
        .pagination-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <nav class="bg-white border-b sticky top-0 z-50 px-6 py-4 shadow-sm">
        <div class="container mx-auto flex flex-col lg:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-black text-xl">Î©</div>
                <h1 class="font-black text-xl tracking-tighter">OmniVerse <span class="text-indigo-600">OVP</span></h1>
            </div>

            <div id="navMenu" class="flex items-center bg-slate-100 p-1 rounded-xl">
                <button onclick="showView('dashboard')" id="nav-dashboard" class="px-5 py-2 rounded-lg text-sm font-bold text-slate-500">å¤§å…å¹¿åœº</button>
                <button onclick="showView('create')" id="nav-create" class="px-5 py-2 rounded-lg text-sm font-bold text-slate-500">å‘å¸ƒå­˜è¯</button>
                <button onclick="showView('history')" id="nav-history" class="hidden px-5 py-2 rounded-lg text-sm font-bold text-slate-500">è®°å½•</button>
                <button onclick="showView('admin')" id="nav-admin" class="hidden px-5 py-2 rounded-lg text-sm font-bold text-slate-500 text-rose-600">ç®¡ç†åå°</button>
            </div>

            <div class="flex items-center gap-3">
                <select id="netSwitcher" onchange="switchNetwork(this.value)" class="bg-slate-50 border rounded-lg px-2 py-2 text-xs font-bold outline-none">
                    <option value="">ç½‘ç»œåˆ‡æ¢...</option>
                    <option value="0xa5bd">Tempo Testnet</option>
                    <option value="0xc488">Somnia Testnet</option>
                    <option value="0xaa36a7">Sepolia Hub</option>
                </select>
                <button id="connectBtn" onclick="connect()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-bold text-sm">è¿æ¥é’±åŒ…</button>
                <div id="userInfo" class="hidden flex items-center gap-2 bg-white border p-1 pr-3 rounded-lg">
                    <div id="userAvatar" class="w-7 h-7 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600 font-black">?</div>
                    <span id="userName" class="text-xs font-bold"></span>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto max-w-5xl px-4 py-8">
        <!-- èšåˆå¤§å… -->
        <div id="view-dashboard" class="view-section space-y-6">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-2xl font-black italic">Consensus Lobby</h2>
                <div id="filterTags" class="flex gap-2"></div>
            </div>
            <div id="globalFeed" class="grid gap-6 md:grid-cols-2"></div>
            <div id="dashboard-pagination" class="flex justify-center gap-3 pt-10"></div>
        </div>

        <!-- å‘å¸ƒè§†å›¾ -->
        <div id="view-create" class="view-section max-w-xl mx-auto">
            <div id="netAlert" class="mb-4 p-4 rounded-xl text-center text-xs font-black"></div>
            <div id="regArea" class="hidden bg-indigo-600 p-8 rounded-3xl text-white mb-6">
                <h2 class="text-2xl font-black mb-4">Register Identity</h2>
                <input type="text" id="regInput" placeholder="è¾“å…¥å½“å‰é“¾æ˜µç§°..." class="w-full p-4 rounded-xl text-slate-900 font-bold mb-4 outline-none">
                <button onclick="handleRegister()" class="w-full bg-white text-indigo-600 py-4 rounded-xl font-black">ç«‹å³æ¿€æ´»</button>
            </div>
            <div id="createArea" class="bg-white border p-8 rounded-3xl shadow-sm">
                <input type="text" id="postTitle" placeholder="å­˜è¯æ ‡é¢˜" class="w-full p-4 bg-slate-50 rounded-xl mb-4 font-bold outline-none">
                <textarea id="postContent" placeholder="Markdown å†…å®¹..." class="w-full p-4 bg-slate-50 rounded-xl h-48 mb-6 font-medium outline-none"></textarea>
                <button id="postBtn" onclick="handlePost()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black">å¹¿æ’­å­˜è¯</button>
            </div>
        </div>

        <!-- æˆ‘çš„è®°å½• -->
        <div id="view-history" class="view-section space-y-6">
            <h2 class="text-2xl font-black border-b pb-4 italic">My Footprints</h2>
            <div id="historyList" class="grid gap-4 md:grid-cols-2"></div>
            <div id="history-pagination" class="flex justify-center gap-3 pt-10"></div>
        </div>

        <!-- ç®¡ç†åå° -->
        <div id="view-admin" class="view-section space-y-6">
            <div class="bg-amber-50 p-8 rounded-[2rem] border border-amber-100">
                <h3 class="text-xl font-black text-amber-900 mb-4">ç”¨æˆ·æƒé™ç®¡ç†</h3>
                <div class="flex gap-2">
                    <input type="text" id="targetAddr" placeholder="0x..." class="flex-1 p-4 rounded-xl outline-none border font-mono text-sm">
                    <button onclick="handleBan(true)" class="bg-rose-500 text-white px-6 py-2 rounded-xl font-bold">å°ç¦</button>
                    <button onclick="handleBan(false)" class="bg-emerald-500 text-white px-6 py-2 rounded-xl font-bold">è§£å°</button>
                </div>
            </div>
            <div class="bg-white border rounded-[2rem] p-8">
                <h4 class="font-black mb-6">å·²æ³¨å†Œç”¨æˆ·åˆ—è¡¨</h4>
                <div id="userList" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- è¯¦æƒ…è§†å›¾ -->
        <div id="view-post" class="view-section">
            <div id="detailContainer" class="bg-white border p-8 md:p-12 rounded-[3rem] shadow-sm"></div>
            <button onclick="goHome()" class="mt-10 text-slate-400 font-bold block mx-auto hover:text-indigo-600">â† è¿”å›å¤§å…</button>
        </div>
    </main>

    <script>
        const NETWORKS = {
            "0xa5bd": { name: "Tempo", proxy: "0xba0c4539deb136356Ac63A4F58772B3BFe772883", rpc: "https://rpc.testnet.tempo.xyz", color: "tempo" },
            "0xc488": { name: "Somnia", proxy: "0xDcB858D6A338d0fe3Cf7E724d95d6ED0f622702c", rpc: "https://dream-rpc.somnia.network", color: "somnia" },
            "0xaa36a7": { name: "Sepolia", proxy: "0x0255d9E3432A39DC3a5F5bC3F05459C7D5c2a25e", rpc: "https://sepolia.drpc.org", color: "sepolia" }
        };

        const ABI = [
            "function register(string _username) public",
            "function createPost(string _title, string _content) public",
            "function getPostCount() view returns (uint256)",
            "function getPaginatedPosts(uint256 _page, uint256 _pageSize) view returns (tuple(uint256 id, string title, string content, address author, string authorName, uint256 createdAt, uint256 updatedAt, string chainLabel, bool exists)[])",
            "function users(address) view returns (string username, bool isBanned, bool isRegistered, address userAddress)",
            "function posts(uint256) view returns (uint256 id, string title, string content, address author, string authorName, uint256 createdAt, uint256 updatedAt, string chainLabel, bool exists)",
            "function getPostIdsByAddress(address _user) view returns (uint256[])",
            "function getUserCount() view returns (uint256)",
            "function allRegisteredUsers(uint256) view returns (address)",
            "function setBannedStatus(address _user, bool _status) public",
            "function owner() view returns (address)"
        ];

        let activeFilters = Object.keys(NETWORKS);
        let userAddr, currentChainId;
        const PAGE_SIZE = 10;

        function parsePost(p, chainId) {
            try {
                return {
                    id: p.id || p[0],
                    title: p.title || p[1],
                    content: p.content || p[2],
                    author: p.author || p[3],
                    authorName: p.authorName || p[4],
                    createdAt: Number(p.createdAt || p[5]),
                    updatedAt: Number(p.updatedAt || p[6]),
                    chainLabel: p.chainLabel || p[7],
                    exists: p.exists !== undefined ? p.exists : p[8],
                    sourceId: chainId
                };
            } catch (e) { return null; }
        }

        window.onload = async () => {
            marked.setOptions({ breaks: true, gfm: true });
            renderFilterUI();
            showView('dashboard'); // é»˜è®¤è¿›å…¥å¤§å…

            if (window.ethereum) {
                const acc = await window.ethereum.request({ method: 'eth_accounts' });
                if (acc.length > 0) connect();
                window.ethereum.on('chainChanged', (id) => { currentChainId = id.toLowerCase(); connect(); });
            }
        };

        async function connect() {
            if (!window.ethereum) return;
            const webProvider = new ethers.BrowserProvider(window.ethereum);
            const signer = await webProvider.getSigner();
            userAddr = await signer.getAddress();
            const net = await webProvider.getNetwork();
            currentChainId = "0x" + net.chainId.toString(16).toLowerCase();
            updateUI();
            checkNetStatus();
        }

        function showView(name) {
            // éšè—æ‰€æœ‰
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('view-active'));
            document.querySelectorAll('#navMenu button').forEach(b => b.classList.remove('nav-link-active'));
            
            // æ˜¾ç¤ºé€‰å®š
            const targetView = document.getElementById(`view-${name}`);
            const targetBtn = document.getElementById(`nav-${name}`);
            
            if (targetView) targetView.classList.add('view-active');
            if (targetBtn) targetBtn.classList.add('nav-link-active');

            if (name === 'dashboard') loadAggregatedFeed(1);
            if (name === 'history') loadMyHistory(1);
            if (name === 'admin') loadAdminPanel();
        }

        async function loadAggregatedFeed(page) {
            const container = document.getElementById('globalFeed');
            container.innerHTML = `<div class="col-span-full py-10 text-center animate-pulse font-bold text-slate-400">è·¨é“¾æ•°æ®åŒæ­¥ä¸­...</div>`;
            
            let pool = [];
            const tasks = activeFilters.map(async (id) => {
                try {
                    const provider = new ethers.JsonRpcProvider(NETWORKS[id].rpc);
                    const contract = new ethers.Contract(NETWORKS[id].proxy, ABI, provider);
                    const posts = await contract.getPaginatedPosts(1, page * PAGE_SIZE);
                    return posts.map(rp => parsePost(rp, id));
                } catch (e) { return []; }
            });

            const results = await Promise.all(tasks);
            results.forEach(list => pool = pool.concat(list.filter(p => p && p.exists)));
            pool.sort((a, b) => b.createdAt - a.createdAt);

            const start = (page - 1) * PAGE_SIZE;
            const final = pool.slice(start, start + PAGE_SIZE);

            let html = "";
            final.forEach(p => html += renderCard(p));
            container.innerHTML = html || "æš‚æ— å†…å®¹";
            renderPagination('dashboard-pagination', page, pool.length > start + PAGE_SIZE, loadAggregatedFeed);
        }

        function renderCard(p) {
            const net = NETWORKS[p.sourceId];
            return `
            <div class="bg-white border rounded-2xl p-6 hover:shadow-lg transition card-${net.color}">
                <div class="flex justify-between items-start mb-3">
                    <span class="text-[9px] font-black px-2 py-0.5 rounded tag-${net.color}">${net.name} #${p.id}</span>
                </div>
                <h3 class="text-lg font-black mb-4 line-clamp-1">${p.title}</h3>
                <div class="flex justify-between items-center pt-4 border-t">
                    <span class="text-xs font-black text-${net.color}">@${p.authorName}</span>
                    <button onclick="goDetail('${p.sourceId}', ${p.id})" class="text-xs font-bold text-indigo-600">è¯¦æƒ… â†’</button>
                </div>
            </div>`;
        }

        async function goDetail(netId, id) {
            showView('post');
            const container = document.getElementById('detailContainer');
            container.innerHTML = "è§£æä¸­...";
            const net = NETWORKS[netId];
            try {
                const contract = new ethers.Contract(net.proxy, ABI, new ethers.JsonRpcProvider(net.rpc));
                const p = await contract.posts(id);
                const post = parsePost(p, netId);
                
                const created = new Date(post.createdAt * 1000).toLocaleString();
                const updated = new Date(post.updatedAt * 1000).toLocaleString();
                const isEdited = post.updatedAt > post.createdAt;

                container.innerHTML = `
                    <div class="mb-6"><span class="tag-${net.color} px-3 py-1 rounded-lg font-black text-[10px] uppercase">${net.name} NETWORK</span></div>
                    <h1 class="text-4xl font-black mb-8 leading-tight">${post.title}</h1>
                    <div class="prose max-w-none text-slate-700 mb-12">${marked.parse(post.content)}</div>
                    <div class="border-t pt-8 space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="font-black text-2xl text-${net.color}">@${post.authorName}</span>
                            <div class="text-right text-[10px] font-bold text-slate-400">
                                <div>å‘å¸ƒæ—¶é—´: ${created}</div>
                                ${isEdited ? `<div class="text-amber-500">ä¿®æ”¹æ—¶é—´: ${updated}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-[10px] font-mono text-slate-300">å­˜è¯ä½œè€…åœ°å€: ${post.author}</div>
                    </div>
                `;
            } catch (e) { container.innerHTML = "è¯»å–å¤±è´¥"; }
        }

        // --- ç®¡ç†é€»è¾‘ ---
        async function loadAdminPanel() {
            const container = document.getElementById('userList');
            container.innerHTML = "æ­£åœ¨æ£€ç´¢èŠ‚ç‚¹ç”¨æˆ·...";
            const net = NETWORKS[currentChainId];
            if (!net) return container.innerHTML = "è¯·å…ˆåˆ‡æ¢è‡³å—æ”¯æŒçš„ç½‘ç»œ";
            
            try {
                const webProvider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(net.proxy, ABI, await webProvider.getSigner());
                const count = await contract.getUserCount();
                let html = `<table class="w-full text-left text-xs"><thead><tr class="text-slate-400 border-b">
                    <th class="pb-4">æ˜µç§°</th><th class="pb-4">åœ°å€</th><th class="pb-4">æ“ä½œçŠ¶æ€</th></tr></thead><tbody>`;
                for(let i=0; i<count; i++) {
                    const addr = await contract.allRegisteredUsers(i);
                    const user = await contract.users(addr);
                    html += `<tr class="border-b"><td class="py-4 font-bold">@${user.username}</td><td class="py-4 font-mono text-slate-400">${addr}</td><td>${user.isBanned?'ğŸ”´ å·²å°ç¦':'ğŸŸ¢ æ­£å¸¸'}</td></tr>`;
                }
                container.innerHTML = html + "</tbody></table>";
            } catch(e) { container.innerHTML = "æ— æƒé™æˆ–è¯»å–å¤±è´¥"; }
        }

        async function handleBan(status) {
            const addr = document.getElementById('targetAddr').value;
            const net = NETWORKS[currentChainId];
            try {
                const webProvider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(net.proxy, ABI, await webProvider.getSigner());
                await (await contract.setBannedStatus(addr, status)).wait();
                alert("æƒé™å·²åŒæ­¥ï¼"); loadAdminPanel();
            } catch(e) { alert("å¤±è´¥ï¼šæ— æƒé™æˆ–ç½‘ç»œé”™è¯¯"); }
        }

        // --- åŸºç¡€è¾…åŠ© ---
        function renderPagination(containerId, current, hasNext, callback) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = `
                <button onclick="${callback.name}(${current - 1})" ${current === 1 ? 'disabled' : ''} class="pagination-btn">â†</button>
                <span class="text-xs font-black text-slate-400 self-center">PAGE ${current}</span>
                <button onclick="${callback.name}(${current + 1})" ${!hasNext ? 'disabled' : ''} class="pagination-btn">â†’</button>
            `;
        }

        async function loadMyHistory(page) {
            const list = document.getElementById('historyList');
            list.innerHTML = `<div class="col-span-full py-10 text-center animate-pulse text-indigo-500">æ£€ç´¢ä¸­...</div>`;
            let myPool = [];
            for (let id in NETWORKS) {
                try {
                    const provider = new ethers.JsonRpcProvider(NETWORKS[id].rpc);
                    const contract = new ethers.Contract(NETWORKS[id].proxy, ABI, provider);
                    const ids = await contract.getPostIdsByAddress(userAddr);
                    for (let pid of ids) {
                        const p = await contract.posts(pid);
                        const parsed = parsePost(p, id);
                        if (parsed && parsed.exists) myPool.push(parsed);
                    }
                } catch(e) {}
            }
            myPool.sort((a, b) => b.createdAt - a.createdAt);
            const start = (page - 1) * PAGE_SIZE;
            const final = myPool.slice(start, start + PAGE_SIZE);
            let html = "";
            final.forEach(p => html += renderCard(p));
            list.innerHTML = html || "æ— è®°å½•";
            renderPagination('history-pagination', page, myPool.length > start + PAGE_SIZE, loadMyHistory);
        }

        function checkNetStatus() {
            const alert = document.getElementById('netAlert');
            const net = NETWORKS[currentChainId];
            if (net) {
                alert.className = `mb-4 p-4 rounded-xl text-center text-xs font-black tag-${net.color}`;
                alert.innerText = `æ¥å…¥ç‚¹ï¼š${net.name}`;
                syncStatus(net);
            } else {
                alert.className = "mb-4 p-4 rounded-xl text-center text-xs font-black bg-rose-100 text-rose-600";
                alert.innerText = "âš ï¸ è¯·åˆ‡æ¢è‡³æ”¯æŒçš„ç½‘ç»œ";
            }
        }

        async function syncStatus(net) {
            const webProvider = new ethers.BrowserProvider(window.ethereum);
            const contract = new ethers.Contract(net.proxy, ABI, await webProvider.getSigner());
            const user = await contract.users(userAddr);
            const owner = await contract.owner();
            document.getElementById('userName').innerText = user.isRegistered ? "@" + user.username : "æœªæ³¨å†Œ";
            document.getElementById('userAvatar').innerText = user.isRegistered ? user.username.charAt(0).toUpperCase() : '?';
            if (user.isRegistered) { document.getElementById('regArea').classList.add('hidden'); document.getElementById('createArea').classList.remove('hidden'); }
            else { document.getElementById('regArea').classList.remove('hidden'); document.getElementById('createArea').classList.add('hidden'); }
            if (userAddr.toLowerCase() === owner.toLowerCase()) document.getElementById('nav-admin').classList.remove('hidden');
        }

        function switchNetwork(id) { if (id && window.ethereum) window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: id }] }); }
        async function handleRegister() {
            const n = document.getElementById('regInput').value;
            try { await (await new ethers.Contract(NETWORKS[currentChainId].proxy, ABI, await (new ethers.BrowserProvider(window.ethereum)).getSigner()).register(n)).wait(); connect(); } catch(e) { alert("å¤±è´¥"); }
        }
        async function handlePost() {
            const t = document.getElementById('postTitle').value; const c = document.getElementById('postContent').value;
            try { await (await new ethers.Contract(NETWORKS[currentChainId].proxy, ABI, await (new ethers.BrowserProvider(window.ethereum)).getSigner()).createPost(t, c)).wait(); goHome(); } catch(e) { alert("å¤±è´¥"); }
        }
        function renderFilterUI() {
            document.getElementById('filterTags').innerHTML = Object.keys(NETWORKS).map(id => `<button onclick="toggleFilter('${id}')" id="tag-${NETWORKS[id].color}" class="text-[9px] font-black px-3 py-1 rounded-lg tag-${NETWORKS[id].color} border">${NETWORKS[id].name}</button>`).join('');
        }
        function toggleFilter(id) {
            if (activeFilters.includes(id)) { activeFilters = activeFilters.filter(i => i !== id); document.getElementById(`tag-${NETWORKS[id].color}`).style.opacity = "0.3"; }
            else { activeFilters.push(id); document.getElementById(`tag-${NETWORKS[id].color}`).style.opacity = "1"; }
            loadAggregatedFeed(1);
        }
        function goHome() { showView('dashboard'); }
        function updateUI() { document.getElementById('connectBtn').classList.add('hidden'); document.getElementById('userInfo').classList.remove('hidden'); document.getElementById('nav-history').classList.remove('hidden'); }
    </script>
</body>
</html>
