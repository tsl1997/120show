<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH è½¬è´¦æŠ€æœ¯å…¨æ™¯å±•ç¤º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        @keyframes pulse-border {
            0% { border-color: rgba(234, 179, 8, 0.5); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); }
            70% { border-color: rgba(234, 179, 8, 0); box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); }
            100% { border-color: rgba(234, 179, 8, 0); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }
        .mining-active { animation: pulse-border 1.5s infinite; }
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .tx-table-container { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .tx-row { transition: background-color 0.2s; border-bottom: 1px solid #334155; }
        .tx-row:hover { background-color: #1e293b; }
        .address-badge { font-family: 'Courier New', Courier, monospace; letter-spacing: -0.5px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">

    <!-- å¤´éƒ¨ -->
    <header class="w-full max-w-5xl flex justify-between items-center mb-10 border-b border-gray-700 pb-6">
        <div>
            <h1 class="text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-purple-400 to-yellow-400">
                ä»¥å¤ªåŠè½¬è´¦æŠ€æœ¯å…¨æ™¯
            </h1>
            <p class="text-gray-400 mt-2">ä»åŸºç¡€ EOA åˆ° CREATE2 é“å·åˆçº¦çš„æ·±åº¦äº¤äº’æ¼”ç¤º</p>
        </div>
        <div class="flex flex-col items-end">
            <button id="connectBtn" onclick="connectWallet()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-full transition shadow-lg shadow-blue-500/30">
                è¿æ¥é’±åŒ…
            </button>
            <div id="networkStatus" class="text-xs text-gray-500 mt-2 hidden"></div>
        </div>
    </header>

    <!-- ä¸»æ§å° -->
    <main class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">
        
        <!-- å·¦ä¾§å¯¼èˆª -->
        <div class="lg:col-span-3 flex flex-col space-y-2">
            <button onclick="switchTab(1)" id="tab1" class="tab-btn active w-full text-left px-6 py-4 rounded-xl bg-blue-600 text-white font-bold shadow-lg transition-all">
                <div class="text-xs opacity-75 mb-1">LEVEL 1</div>
                æ™®é€šè½¬è´¦ (EOA)
            </button>
            <button onclick="switchTab(2)" id="tab2" class="tab-btn w-full text-left px-6 py-4 rounded-xl bg-gray-800 hover:bg-gray-750 text-gray-400 font-medium transition-all">
                <div class="text-xs opacity-75 mb-1">LEVEL 2</div>
                åˆçº¦ä¸­è½¬ (Contract)
            </button>
            <button onclick="switchTab(3)" id="tab3" class="tab-btn w-full text-left px-6 py-4 rounded-xl bg-gray-800 hover:bg-gray-750 text-gray-400 font-medium transition-all">
                <div class="text-xs opacity-75 mb-1">LEVEL 3</div>
                ä¸´æ—¶éšåŒ¿ (Proxy)
            </button>
            <button onclick="switchTab(4)" id="tab4" class="tab-btn w-full text-left px-6 py-4 rounded-xl bg-gray-800 hover:bg-gray-750 text-gray-400 font-medium transition-all">
                <div class="text-xs opacity-75 mb-1">LEVEL 4</div>
                é“å·å®šåˆ¶ (CREATE2)
            </button>
        </div>

        <!-- å³ä¾§äº¤äº’åŒº -->
        <div class="lg:col-span-9 bg-gray-800 border border-gray-700 rounded-2xl p-8 shadow-2xl relative min-h-[320px]">
            
            <!-- Scene 1 -->
            <div id="scene1" class="scene-content">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white">æ™®é€šè½¬è´¦ (EOA -> EOA)</h2>
                        <p class="text-gray-400 text-sm mt-2">æœ€åŸºç¡€çš„è½¬è´¦ã€‚èµ„é‡‘ç›´æ¥ä»ä½ çš„é’±åŒ…æµå‘ç›®æ ‡åœ°å€ã€‚Gas æ¶ˆè€—æœ€ä½ã€‚</p>
                    </div>
                    <span class="bg-blue-900 text-blue-300 px-3 py-1 rounded text-xs font-mono border border-blue-700">Gas: ~21,000</span>
                </div>
                <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700 space-y-4">
                    <label class="text-sm text-gray-400">æ¥æ”¶æ–¹åœ°å€</label>
                    <input type="text" id="input1_to" placeholder="0x..." class="w-full bg-gray-800 border border-gray-600 rounded-lg p-4 text-white focus:border-blue-500 outline-none font-mono">
                    <button onclick="executeScene1()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 py-4 rounded-lg font-bold text-white transition shadow-lg">
                        å‘é€ 0.0001 ETH
                    </button>
                </div>
            </div>

            <!-- Scene 2 -->
            <div id="scene2" class="scene-content hidden">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-purple-400">åˆçº¦ä¸­è½¬ (Contract -> EOA)</h2>
                        <p class="text-gray-400 text-sm mt-2">èµ„é‡‘å…ˆè¿›å…¥å·¥å‚åˆçº¦ï¼Œå†ç”±åˆçº¦è½¬å‘ã€‚é“¾ä¸Šå‘é€æ–¹æ˜¾ç¤ºä¸ºå·¥å‚åˆçº¦åœ°å€ã€‚</p>
                    </div>
                    <span class="bg-purple-900 text-purple-300 px-3 py-1 rounded text-xs font-mono border border-purple-700">Type: Call</span>
                </div>
                <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700 space-y-4">
                    <label class="text-sm text-gray-400">æ¥æ”¶æ–¹åœ°å€</label>
                    <input type="text" id="input2_to" placeholder="0x..." class="w-full bg-gray-800 border border-gray-600 rounded-lg p-4 text-white focus:border-purple-500 outline-none font-mono">
                    <button onclick="executeScene2()" class="w-full bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-400 py-4 rounded-lg font-bold text-white transition shadow-lg">
                        æ‰§è¡Œåˆçº¦è½¬è´¦
                    </button>
                </div>
            </div>

            <!-- Scene 3 -->
            <div id="scene3" class="scene-content hidden">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-pink-400">ä¸´æ—¶éšåŒ¿è½¬è´¦ (Factory -> Proxy -> EOA)</h2>
                        <p class="text-gray-400 text-sm mt-2">æ¯æ¬¡è½¬è´¦éƒ½ä¼šç°åœºéƒ¨ç½²ä¸€ä¸ªå…¨æ–°çš„ä¸´æ—¶åˆçº¦ï¼Œè½¬å®Œå³ç„šã€‚æ”¶æ¬¾æ–¹çœ‹åˆ°çš„å‘é€è€…æ¯æ¬¡éƒ½æ˜¯ä¸åŒçš„ã€‚</p>
                    </div>
                    <span class="bg-pink-900 text-pink-300 px-3 py-1 rounded text-xs font-mono border border-pink-700">Opcode: CREATE</span>
                </div>
                <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700 space-y-4">
                    <label class="text-sm text-gray-400">æ¥æ”¶æ–¹åœ°å€</label>
                    <input type="text" id="input3_to" placeholder="0x..." class="w-full bg-gray-800 border border-gray-600 rounded-lg p-4 text-white focus:border-pink-500 outline-none font-mono">
                    <button onclick="executeScene3()" class="w-full bg-gradient-to-r from-pink-600 to-pink-500 hover:from-pink-500 hover:to-pink-400 py-4 rounded-lg font-bold text-white transition shadow-lg">
                        ç”Ÿæˆä¸´æ—¶åœ°å€å¹¶è½¬è´¦
                    </button>
                </div>
            </div>

            <!-- Scene 4 -->
            <div id="scene4" class="scene-content hidden">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-yellow-400">é“å·å®šåˆ¶è½¬è´¦ (CREATE2)</h2>
                        <p class="text-gray-400 text-sm mt-2">é€šè¿‡å‰ç«¯æŒ–çŸ¿å¯»æ‰¾ Saltï¼Œç”ŸæˆæŒ‡å®šåç¼€çš„ä¸´æ—¶åˆçº¦åœ°å€è¿›è¡Œè½¬è´¦ã€‚</p>
                    </div>
                    <span class="bg-yellow-900 text-yellow-300 px-3 py-1 rounded text-xs font-mono border border-yellow-700">Opcode: CREATE2</span>
                </div>
                
                <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label class="text-sm text-gray-400">æ¥æ”¶æ–¹åœ°å€</label>
                            <input type="text" id="input4_to" placeholder="0x..." class="w-full bg-gray-800 border border-gray-600 rounded-lg p-4 text-white outline-none font-mono text-sm">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">ç›®æ ‡åç¼€</label>
                            <input type="text" id="input4_suffix" value="666" maxlength="5" placeholder="e.g. 666" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-4 text-center font-bold text-yellow-400 outline-none font-mono tracking-widest">
                        </div>
                    </div>

                    <div id="miningResult" class="hidden bg-green-900/20 border border-green-500/50 p-4 rounded-lg">
                        <div class="flex items-center text-green-400 font-bold mb-1">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            æ‰¾åˆ° Salt!
                        </div>
                        <div class="text-gray-400 text-xs font-mono break-all">Salt: <span id="resSalt" class="text-white"></span></div>
                        <div class="text-gray-300 text-sm font-mono mt-2">
                            é¢„æµ‹å‘é€æ–¹åœ°å€: <span id="resAddr" class="text-yellow-400 font-bold bg-yellow-900/30 px-2 py-1 rounded"></span>
                        </div>
                    </div>

                    <div class="flex space-x-3">
                        <button id="btnMine" onclick="startMining()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-4 rounded-lg font-bold text-white transition">
                            1. è®¡ç®— (Mine)
                        </button>
                        <button id="btnDeployCreate2" onclick="executeScene4()" disabled class="flex-1 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 py-4 rounded-lg font-bold text-white transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                            2. éƒ¨ç½²å¹¶è½¬è´¦
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨ï¼šäº¤æ˜“è¿½è¸ªè¡¨æ ¼ -->
    <section class="w-full max-w-5xl">
        <h3 class="text-xl font-bold text-white mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            é“¾ä¸Šäº¤äº’è®°å½•
        </h3>
        
        <div class="w-full overflow-x-auto rounded-xl border border-gray-700 tx-table-container">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-800 text-gray-400 text-xs uppercase tracking-wider">
                        <th class="p-4 font-semibold border-b border-gray-700">äº¤æ˜“ç±»å‹</th>
                        <th class="p-4 font-semibold border-b border-gray-700">å‘é€æ–¹ (From / Via)</th>
                        <th class="p-4 font-semibold border-b border-gray-700">æ¥æ”¶æ–¹ (To)</th>
                        <th class="p-4 font-semibold border-b border-gray-700">é‡‘é¢ (ETH)</th>
                        <th class="p-4 font-semibold border-b border-gray-700 text-right">é“¾ä¸ŠéªŒè¯</th>
                    </tr>
                </thead>
                <tbody id="txTableBody" class="bg-gray-900 text-sm">
                    <tr id="emptyRow">
                        <td colspan="5" class="p-8 text-center text-gray-600 italic">æš‚æ— äº¤æ˜“è®°å½•ï¼Œè¯·æ‰§è¡Œä¸Šæ–¹æ“ä½œ...</td>
                    </tr>
                    <!-- åŠ¨æ€æ’å…¥è¡Œ -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- JS é€»è¾‘ -->
    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const CONTRACT_ADDRESS = "0x9d3312056e19A54C17Eb6763DAE3Ef571220925F";
        
        // ä½ çš„ç¼–è¯‘äº§ç‰© (å·²æ·»åŠ  '0x')
        const TRANSFER_PROXY_BYTECODE = "0x608060405260405161022938038061022983398181016040528101906100259190610144565b5f8173ffffffffffffffffffffffffffffffffffffffff164760405161004a9061019c565b5f6040518083038185875af1925050503d805f8114610084576040519150601f19603f3d011682016040523d82523d5f602084013e610089565b606091505b50509050806100cd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100c49061020a565b60405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff16ff5b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610113826100ea565b9050919050565b61012381610109565b811461012d575f5ffd5b50565b5f8151905061013e8161011a565b92915050565b5f60208284031215610159576101586100e6565b5b5f61016684828501610130565b91505092915050565b5f81905092915050565b50565b5f6101875f8361016f565b915061019282610179565b5f82019050919050565b5f6101a68261017c565b9150819050919050565b5f82825260208201905092915050565b7f50726f7879207472616e73666572206661696c656400000000000000000000005f82015250565b5f6101f46015836101b0565b91506101ff826101c0565b602082019050919050565b5f6020820190508181035f830152610221816101e8565b905091905056fe";

        const ABI = [
            { "anonymous": false, "inputs": [ { "indexed": false, "internalType": "string", "name": "logType", "type": "string" }, { "indexed": true, "internalType": "address", "name": "sender", "type": "address" }, { "indexed": true, "internalType": "address", "name": "recipient", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "via", "type": "address" } ], "name": "TransferLog", "type": "event" },
            { "inputs": [ { "internalType": "address payable", "name": "recipient", "type": "address" } ], "name": "transferViaContract", "outputs": [], "stateMutability": "payable", "type": "function" },
            { "inputs": [ { "internalType": "address payable", "name": "recipient", "type": "address" } ], "name": "transferViaTemp", "outputs": [], "stateMutability": "payable", "type": "function" },
            { "inputs": [ { "internalType": "address payable", "name": "recipient", "type": "address" }, { "internalType": "bytes32", "name": "salt", "type": "bytes32" } ], "name": "transferViaCreate2", "outputs": [], "stateMutability": "payable", "type": "function" }
        ];

        let provider, signer, contract;
        let foundSalt = null;
        let userAddress = "";

        // ================= è¿æ¥ä¸ç›‘å¬ =================
        async function connectWallet() {
            if (!window.ethereum) return alert("è¯·å®‰è£… MetaMask!");
            try {
                const sepoliaChainId = "0xaa36a7";
                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (currentChainId !== sepoliaChainId) {
                    try {
                        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: sepoliaChainId }] });
                    } catch (err) { return alert("è¯·åœ¨é’±åŒ…ä¸­åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘"); }
                }

                provider = new ethers.BrowserProvider(window.ethereum, "any");
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                const btn = document.getElementById('connectBtn');
                btn.innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
                btn.className = "bg-green-600 text-white font-bold py-2 px-8 rounded-full shadow-lg";
                document.getElementById('networkStatus').innerText = "Network: Sepolia (11155111)";
                document.getElementById('networkStatus').classList.remove('hidden');

                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                // ç›‘å¬åˆçº¦äº‹ä»¶ï¼Œè‡ªåŠ¨å¡«è¡¨
                contract.on("TransferLog", (logType, sender, recipient, amount, via, event) => {
                    // è§£æç±»å‹
                    let displayType = "æœªçŸ¥";
                    let badgeColor = "bg-gray-600";
                    if(logType.includes("Scenario2")) { displayType = "LEVEL 2: åˆçº¦è½¬è´¦"; badgeColor = "bg-purple-600"; }
                    if(logType.includes("Scenario3")) { displayType = "LEVEL 3: ä¸´æ—¶éšåŒ¿"; badgeColor = "bg-pink-600"; }
                    if(logType.includes("Scenario4")) { displayType = "LEVEL 4: é“å·å®šåˆ¶"; badgeColor = "bg-yellow-600"; }

                    const txHash = event?.log?.transactionHash || event?.transactionHash;
                    
                    // æ³¨æ„ï¼šè¿™é‡Œçš„ 'via' æ˜¯å®é™…å‡ºé’±çš„åœ°å€
                    addTableRow(displayType, badgeColor, via, recipient, amount, txHash);
                });

            } catch (err) {
                if (err.message && err.message.includes("network changed")) window.location.reload();
                else alert("è¿æ¥é”™è¯¯: " + err.message);
            }
        }

        // ================= æ ¸å¿ƒï¼šè¡¨æ ¼ç”Ÿæˆ =================
        function addTableRow(type, badgeClass, fromAddr, toAddr, amount, txHash) {
            const tbody = document.getElementById('txTableBody');
            const emptyRow = document.getElementById('emptyRow');
            if(emptyRow) emptyRow.remove();

            // ç”Ÿæˆé¢œè‰²å—
            const fromColor = generateColorFromAddress(fromAddr);
            const toColor = generateColorFromAddress(toAddr);

            const row = document.createElement('tr');
            row.className = "tx-row animate-fade-in";
            
            // æ ¼å¼åŒ–é‡‘é¢
            const ethAmount = ethers.formatEther(amount);
            // æ ¼å¼åŒ–åœ°å€ (å‰6å4)
            const fmtFrom = fromAddr.slice(0,8) + "..." + fromAddr.slice(-6);
            const fmtTo = toAddr.slice(0,8) + "..." + toAddr.slice(-6);

            row.innerHTML = `
                <td class="p-4">
                    <span class="${badgeClass} text-white text-xs font-bold px-2 py-1 rounded shadow-sm whitespace-nowrap">${type}</span>
                </td>
                <td class="p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded shadow-sm" style="background-color: ${fromColor}"></div>
                        <span class="text-gray-300 font-mono text-sm address-badge" title="${fromAddr}">${fmtFrom}</span>
                    </div>
                </td>
                <td class="p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded shadow-sm" style="background-color: ${toColor}"></div>
                        <span class="text-gray-300 font-mono text-sm address-badge" title="${toAddr}">${fmtTo}</span>
                    </div>
                </td>
                <td class="p-4 font-mono font-bold text-white">${ethAmount} ETH</td>
                <td class="p-4 text-right">
                    <a href="https://sepolia.etherscan.io/tx/${txHash}" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs font-medium border border-blue-800 hover:border-blue-500 px-3 py-1.5 rounded transition">
                        View on Chain â†—
                    </a>
                </td>
            `;
            
            // æ’å…¥åˆ°ç¬¬ä¸€è¡Œ
            tbody.insertBefore(row, tbody.firstChild);
        }

        // æ ¹æ®åœ°å€ç”Ÿæˆå›ºå®šçš„ HSL é¢œè‰²
        function generateColorFromAddress(address) {
            if(!address) return "#ccc";
            const cleanAddr = address.toLowerCase().replace("0x", "");
            // å–å‰å‡ ä¸ªå­—ç¬¦è½¬æ•°å­—åš Hue
            const seed = parseInt(cleanAddr.slice(0, 8), 16);
            const hue = seed % 360;
            return `hsl(${hue}, 65%, 50%)`;
        }

        // ================= ä¸šåŠ¡é€»è¾‘ =================
        async function executeScene1() {
            if(!signer) return alert("è¯·è¿æ¥é’±åŒ…");
            const to = document.getElementById('input1_to').value;
            if(!ethers.isAddress(to)) return alert("åœ°å€æ— æ•ˆ");
            
            try {
                const btn = document.activeElement;
                const originalText = btn.innerText;
                btn.innerText = "å‘é€ä¸­...";
                btn.disabled = true;

                const tx = await signer.sendTransaction({ to: to, value: ethers.parseEther("0.0001") });
                await tx.wait();
                
                // åœºæ™¯1 æ‰‹åŠ¨æ·»åŠ è®°å½• (å› ä¸ºå®ƒä¸èµ°åˆçº¦äº‹ä»¶)
                addTableRow("LEVEL 1: æ™®é€šè½¬è´¦", "bg-blue-600", userAddress, to, ethers.parseEther("0.0001"), tx.hash);
                
                btn.innerText = originalText;
                btn.disabled = false;
            } catch(e) { alert(e.message); document.activeElement.innerText = "å‘é€ 0.0001 ETH"; document.activeElement.disabled = false; }
        }

        async function executeScene2() {
            if(!contract) return alert("è¯·è¿æ¥é’±åŒ…");
            try {
                const tx = await contract.transferViaContract(document.getElementById('input2_to').value, { value: ethers.parseEther("0.0001") });
                await tx.wait();
            } catch(e) { alert(e.message); }
        }

        async function executeScene3() {
            if(!contract) return alert("è¯·è¿æ¥é’±åŒ…");
            try {
                const tx = await contract.transferViaTemp(document.getElementById('input3_to').value, { value: ethers.parseEther("0.0001") });
                await tx.wait();
            } catch(e) { alert(e.message); }
        }

        async function startMining() {
            const suffix = document.getElementById('input4_suffix').value;
            const to = document.getElementById('input4_to').value;
            
            if(!suffix || !to) return alert("è¯·å¡«å†™å®Œæ•´");
            
            const btn = document.getElementById('btnMine');
            btn.innerText = "ğŸ”¥ æ­£åœ¨æš´åŠ›è®¡ç®—...";
            btn.classList.add('mining-active');

            // å¼‚æ­¥æ‰§è¡Œé˜²æ­¢å¡é¡¿
            setTimeout(() => {
                try {
                    const abiCoder = new ethers.AbiCoder();
                    const cleanBytecode = TRANSFER_PROXY_BYTECODE.replace("0x", "");
                    // æ³¨æ„ï¼šaddress ç¼–ç åæ˜¯ 32 å­—èŠ‚ (64 hex chars)
                    const encodedArgs = abiCoder.encode(["address"], [to]).slice(2);
                    const initCode = cleanBytecode + encodedArgs;
                    const initCodeHash = ethers.keccak256("0x" + initCode);

                    let nonce = 0, found = false;
                    const factoryAddr = CONTRACT_ADDRESS;

                    while (!found) {
                        nonce++;
                        const salt = ethers.zeroPadValue(ethers.toBeHex(nonce), 32);
                        const concatString = ethers.solidityPacked(
                            ["bytes1", "address", "bytes32", "bytes32"],
                            ["0xff", factoryAddr, salt, initCodeHash]
                        );
                        const addr = "0x" + ethers.keccak256(concatString).slice(26);

                        if (addr.toLowerCase().endsWith(suffix.toLowerCase())) {
                            found = true;
                            foundSalt = salt;
                            
                            document.getElementById('resSalt').innerText = salt;
                            document.getElementById('resAddr').innerText = addr;
                            document.getElementById('miningResult').classList.remove('hidden');
                            document.getElementById('btnDeployCreate2').disabled = false;
                        }
                        if (nonce > 1000000) { alert("åç¼€å¤ªéš¾äº†ï¼Œæ¢ä¸ªçŸ­ç‚¹çš„å§ (æ¨è 2-3 ä½)"); break; }
                    }
                } catch (e) { console.error(e); alert("è®¡ç®—é”™è¯¯: " + e.message); }
                finally {
                    btn.innerText = "1. è®¡ç®— (Mine)";
                    btn.classList.remove('mining-active');
                }
            }, 50);
        }

        async function executeScene4() {
            if(!foundSalt) return;
            try {
                const tx = await contract.transferViaCreate2(document.getElementById('input4_to').value, foundSalt, { value: ethers.parseEther("0.0001") });
                await tx.wait();
            } catch(e) { alert(e.message); }
        }

        function switchTab(num) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.className = "tab-btn w-full text-left px-6 py-4 rounded-xl bg-gray-800 hover:bg-gray-750 text-gray-400 font-medium transition-all";
            });
            const activeBtn = document.getElementById(`tab${num}`);
            activeBtn.className = "tab-btn active w-full text-left px-6 py-4 rounded-xl bg-" + 
                (num==1?"blue":num==2?"purple":num==3?"pink":"yellow") + "-600 text-white font-bold shadow-lg transition-all";
            
            document.querySelectorAll('.scene-content').forEach(div => div.classList.add('hidden'));
            document.getElementById(`scene${num}`).classList.remove('hidden');
        }
    </script>
</body>
</html>
