<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniVerse Protocol | 跨链存证中心 v6.6 (Gallery + Edit Fix)</title>
    <!-- 引入配置文件 -->
    <script src="config.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 基础动画与样式 */
        .view-section { display: none; }
        .view-active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-link-active { background: #4f46e5 !important; color: white !important; }
        .pagination-btn { background: white; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 12px; }
        .pagination-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        /* 标签颜色主题 */
        .tag-theme-1 { background:#eef2ff; color:#4338ca; border:1px solid #c7d2fe; } .text-theme-1 { color:#4338ca; } .card-theme-1 { border-left:5px solid #4338ca; }
        .tag-theme-2 { background:#ecfdf5; color:#059669; border:1px solid #a7f3d0; } .text-theme-2 { color:#059669; } .card-theme-2 { border-left:5px solid #059669; }
        .tag-theme-3 { background:#fffbeb; color:#d97706; border:1px solid #fde68a; } .text-theme-3 { color:#d97706; } .card-theme-3 { border-left:5px solid #d97706; }
        .tag-theme-4 { background:#fef2f2; color:#dc2626; border:1px solid #fecaca; } .text-theme-4 { color:#dc2626; } .card-theme-4 { border-left:5px solid #dc2626; }
        .tag-theme-5 { background:#f3e8ff; color:#8b5cf6; border:1px solid #ddd6fe; } .text-theme-5 { color:#8b5cf6; } .card-theme-5 { border-left:5px solid #8b5cf6; }
        .tag-theme-6 { background:#fff5e6; color:#f97316; border:1px solid #fed7aa; } .text-theme-6 { color:#f97316; } .card-theme-6 { border-left:5px solid #f97316; }
        .tag-theme-7 { background:#f0f9ff; color:#0ea5e9; border:1px solid #bae6fd; } .text-theme-7 { color:#0ea5e9; } .card-theme-7 { border-left:5px solid #0ea5e9; }
        .tag-theme-8 { background:#f0fdfa; color:#0d9488; border:1px solid #99f6e4; } .text-theme-8 { color:#0d9488; } .card-theme-8 { border-left:5px solid #0d9488; }
        .tag-theme-9 { background:#fefce8; color:#ca8a04; border:1px solid #fef08a; } .text-theme-9 { color:#ca8a04; } .card-theme-9 { border-left:5px solid #ca8a04; }
        .tag-theme-10 { background:#faf5ff; color:#9333ea; border:1px solid #e9d5ff; } .text-theme-10 { color:#9333ea; } .card-theme-10 { border-left:5px solid #9333ea; }

        /* 福利兔风格 - 瀑布流卡片样式 */
        .gallery-card {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background: #f1f5f9;
            aspect-ratio: 3/4; 
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .gallery-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .gallery-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        .gallery-card:hover .gallery-img {
            transform: scale(1.05);
        }
        .gallery-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 60%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 16px;
        }
        /* 移动端默认显示标题，桌面端悬停显示 */
        @media (min-width: 768px) {
            .gallery-overlay { opacity: 0; }
            .gallery-card:hover .gallery-overlay { opacity: 1; }
        }
        @media (max-width: 767px) {
            .gallery-overlay { opacity: 1; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 50%); }
        }

        .gallery-title {
            color: white;
            font-weight: 900;
            font-size: 1rem;
            line-height: 1.4;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .gallery-meta {
            color: rgba(255,255,255,0.9);
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .gallery-badge {
            background: #4f46e5;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <!-- 导航栏 -->
    <nav class="bg-white border-b sticky top-0 z-50 px-4 py-3 shadow-sm">
        <div class="container mx-auto flex flex-wrap justify-between items-center gap-y-3">
            <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-indigo-600 rounded-lg md:rounded-xl flex items-center justify-center text-white font-black text-lg md:text-xl">Ω</div>
                <h1 class="font-black text-lg md:text-xl tracking-tighter">OmniVerse <span class="text-indigo-600">V6</span></h1>
            </div>
            
            <div class="flex items-center gap-2 lg:order-3">
                <select id="netSwitcher" onchange="switchNetwork(this.value)" class="bg-slate-50 border rounded-lg px-2 py-2 text-xs font-bold outline-none max-w-[120px]"></select>
                <button id="connectBtn" onclick="connect()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-xs md:text-sm whitespace-nowrap">连接钱包</button>
                <div id="userInfo" class="hidden flex items-center gap-2 bg-white border p-1 pr-3 rounded-lg">
                    <div id="userAvatar" class="w-7 h-7 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600 font-black">?</div>
                    <span id="userName" class="text-xs font-bold whitespace-nowrap"></span>
                </div>
            </div>

            <!-- 导航菜单 -->
            <!-- 修改点：增加了 gap-2 (移动端) 和 md:gap-6 (桌面端)，让按钮间距更大 -->
            <div class="w-full lg:w-auto lg:flex-1 lg:order-2">
                 <div id="navMenu" class="flex items-center bg-slate-100 p-1 rounded-xl w-full justify-around md:justify-center gap-2 md:gap-6">
                    <button onclick="showView('dashboard')" id="nav-dashboard" class="px-3 py-1.5 md:px-5 md:py-2 rounded-lg text-xs md:text-sm font-bold text-slate-500 flex-1 md:flex-none">大厅</button>
                    <!-- 看图 -->
                    <button onclick="showView('gallery')" id="nav-gallery" class="px-3 py-1.5 md:px-5 md:py-2 rounded-lg text-xs md:text-sm font-bold text-slate-500 flex-1 md:flex-none text-pink-500">看图</button>
                    <button onclick="showView('create')" id="nav-create" class="px-3 py-1.5 md:px-5 md:py-2 rounded-lg text-xs md:text-sm font-bold text-slate-500 flex-1 md:flex-none">发布</button>
                    <button onclick="showView('history')" id="nav-history" class="hidden px-3 py-1.5 md:px-5 md:py-2 rounded-lg text-xs md:text-sm font-bold text-slate-500 flex-1 md:flex-none">记录</button>
                    <button onclick="showView('admin')" id="nav-admin" class="hidden px-3 py-1.5 md:px-5 md:py-2 rounded-lg text-xs md:text-sm font-bold text-slate-500 text-rose-600 flex-1 md:flex-none">管理</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto max-w-7xl px-4 py-8">
        
        <!-- 1. 大厅 View -->
        <div id="view-dashboard" class="view-section space-y-6">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-2xl font-black italic">Consensus Lobby</h2>
                <div id="filterTags" class="flex gap-2 flex-wrap justify-end max-w-[60%]"></div>
            </div>
            <div id="globalFeed" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
            <div id="dashboard-pagination" class="flex justify-center gap-3 pt-10"></div>
        </div>

        <!-- 2. 看图 View -->
        <div id="view-gallery" class="view-section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-pink-600">Visual Gallery</h2>
                <div class="text-xs font-bold text-slate-400">放松一下，看看美图</div>
            </div>
            <!-- 图片网格 -->
            <div id="galleryFeed" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                <!-- Javascript will populate this -->
            </div>
            <div id="gallery-pagination" class="flex justify-center gap-3 pt-10"></div>
        </div>

        <!-- 3. 发布 View -->
        <div id="view-create" class="view-section max-w-xl mx-auto">
            <div id="netAlert" class="mb-4 p-4 rounded-xl text-center text-xs font-black"></div>
            
            <div id="regArea" class="hidden bg-indigo-600 p-8 rounded-3xl text-white mb-6">
                <h2 class="text-2xl font-black mb-4">Register Identity</h2>
                <input type="text" id="regInput" placeholder="输入当前链昵称..." class="w-full p-4 rounded-xl text-slate-900 font-bold mb-4 outline-none">
                <button onclick="handleRegister()" class="w-full bg-white text-indigo-600 py-4 rounded-xl font-black">立即激活</button>
            </div>

            <div id="createArea" class="bg-white border p-8 rounded-3xl shadow-sm">
                <h3 class="text-lg font-black mb-4">创建新存证</h3>
                <input type="text" id="postTitle" placeholder="标题" class="w-full p-4 bg-slate-50 rounded-xl mb-4 font-bold outline-none border focus:border-indigo-500">
                
                <!-- V6 特有字段 -->
                <div id="v6-fields" class="hidden mb-4 p-4 bg-pink-50 rounded-xl border border-pink-100">
                    <label class="block text-xs font-bold text-pink-600 mb-2">封面设置 (V6 Feature)</label>
                    <input type="text" id="coverUrl" placeholder="封面图片 URL (可选)" class="w-full p-3 bg-white rounded-lg text-sm mb-2 outline-none border">
                    <div class="text-[10px] text-pink-400">*如果不填，系统将自动尝试从内容中抓取第一张图片。</div>
                </div>

                <textarea id="postContent" placeholder="Markdown 内容 (支持图片链接 ![img](url))..." class="w-full p-4 bg-slate-50 rounded-xl h-48 mb-6 font-medium outline-none border focus:border-indigo-500"></textarea>
                <button id="postBtn" onclick="handlePost()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black hover:bg-slate-800 transition">广播存证</button>
            </div>
        </div>

        <!-- 4. 编辑 View (已增强) -->
        <div id="view-edit" class="view-section max-w-xl mx-auto">
            <div class="bg-white border p-8 rounded-3xl shadow-sm">
                <h2 class="text-2xl font-black mb-6">编辑帖子</h2>
                <input type="hidden" id="editPostId"><input type="hidden" id="editPostNetId">
                <input type="text" id="editTitle" placeholder="存证标题" class="w-full p-4 bg-slate-50 rounded-xl mb-4 font-bold outline-none border focus:border-indigo-500">
                
                <!-- 修改点：编辑页面也增加了 V6 封面修改字段 -->
                <div id="edit-v6-fields" class="hidden mb-4 p-4 bg-pink-50 rounded-xl border border-pink-100">
                    <label class="block text-xs font-bold text-pink-600 mb-2">修改封面 (V6 Feature)</label>
                    <input type="text" id="editCoverUrl" placeholder="封面图片 URL" class="w-full p-3 bg-white rounded-lg text-sm mb-2 outline-none border">
                </div>

                <textarea id="editContent" placeholder="Markdown 内容..." class="w-full p-4 bg-slate-50 rounded-xl h-48 mb-6 font-medium outline-none border focus:border-indigo-500"></textarea>
                <div class="flex gap-4">
                     <button onclick="goBack()" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-xl font-bold">取消</button>
                     <button id="updateBtn" onclick="handleUpdate()" class="flex-[2] bg-indigo-600 text-white py-4 rounded-xl font-black">更新存证</button>
                </div>
            </div>
        </div>

        <!-- 5. 历史 View -->
        <div id="view-history" class="view-section space-y-6">
            <h2 class="text-2xl font-black border-b pb-4 italic">My Footprints (当前链)</h2>
            <div id="historyList" class="grid gap-4 md:grid-cols-2"></div>
            <div id="history-pagination" class="flex justify-center gap-3 pt-10"></div>
        </div>

        <!-- 6. 管理 View -->
        <div id="view-admin" class="view-section space-y-6">
            <div class="bg-amber-50 p-8 rounded-[2rem] border border-amber-100">
                <h3 class="text-xl font-black text-amber-900 mb-4">用户权限管理</h3>
                <div class="flex gap-2">
                    <input type="text" id="targetAddr" placeholder="0x..." class="flex-1 p-4 rounded-xl outline-none border font-mono text-sm">
                    <button onclick="handleBan(true)" class="bg-rose-500 text-white px-6 py-2 rounded-xl font-bold">封禁</button>
                    <button onclick="handleBan(false)" class="bg-emerald-500 text-white px-6 py-2 rounded-xl font-bold">解封</button>
                </div>
            </div>
            <div class="bg-white border rounded-[2rem] p-8">
                <h4 class="font-black mb-6">已注册用户列表 (当前链)</h4>
                <div id="userList" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- 7. 详情 View -->
        <div id="view-post" class="view-section">
            <div id="detailContainer" class="bg-white border p-8 md:p-12 rounded-[3rem] shadow-sm max-w-4xl mx-auto"></div>
            <button onclick="goBack()" class="mt-10 text-slate-400 font-bold block mx-auto hover:text-indigo-600">← 返回</button>
        </div>
    </main>

    <script>
        // --- V6 ABI ---
        const V6_ABI = [
            "function register(string _username) public",
            "function createPost(string _title, string _content, string _coverImageUrl, uint8 _imageCount) public",
            "function updatePost(uint256 _id, string _newTitle, string _newContent, string _newCoverImageUrl, uint8 _newImageCount) public",
            "function deletePost(uint256 _id) public",
            "function getPostCount() view returns (uint256)",
            "function getPaginatedPosts(uint256 _page, uint256 _pageSize) view returns (tuple(uint256 id, string title, string content, address author, string authorName, uint256 createdAt, uint256 updatedAt, string chainLabel, bool exists, string coverImageUrl, uint8 imageCount)[])",
            "function users(address) view returns (string username, bool isBanned, bool isRegistered, address userAddress)",
            "function posts(uint256) view returns (uint256 id, string title, string content, address author, string authorName, uint256 createdAt, uint256 updatedAt, string chainLabel, bool exists, string coverImageUrl, uint8 imageCount)",
            "function getPostIdsByAddress(address _user) view returns (uint256[])",
            "function getUserCount() view returns (uint256)",
            "function allRegisteredUsers(uint256) view returns (address)",
            "function setBannedStatus(address _user, bool _status) public",
            "function owner() view returns (address)"
        ];

        let activeFilters = [];
        let userAddr, currentChainId;
        let lastView = 'dashboard';
        const PAGE_SIZE = 12; 
        const THEMES = ['theme-1', 'theme-2', 'theme-3', 'theme-4', 'theme-5', 'theme-6', 'theme-7', 'theme-8', 'theme-9', 'theme-10'];
        
        // V6 链配置
        const V6_CHAINS = ["0xa5bd"]; 

        window.onload = async () => {
            marked.setOptions({ breaks: true, gfm: true });
            Object.keys(NETWORKS).forEach((id, index) => { NETWORKS[id].theme = THEMES[index % THEMES.length]; });
            activeFilters = Object.keys(NETWORKS); 
            renderFilterUI();
            renderNetworkSwitcher();
            const urlParams = new URLSearchParams(window.location.search);
            const netId = urlParams.get('netId'), postId = urlParams.get('postId');
            if (netId && postId && NETWORKS[netId]) { goDetail(netId, postId); } else { showView('dashboard'); }
            
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
                const acc = await window.ethereum.request({ method: 'eth_accounts' });
                if (acc.length > 0) connect();
            }
        };

        function isV6(chainId) { return V6_CHAINS.includes(chainId); }
        function getABI(chainId) { return isV6(chainId) ? V6_ABI : ABI; }
        function extractImageFromMarkdown(content) {
            if (!content) return null;
            const regex = /!\[.*?\]\((.*?)\)/;
            const match = content.match(regex);
            return match ? match[1] : null;
        }
        function countImagesInMarkdown(content) {
            if (!content) return 0;
            const regex = /!\[.*?\]\((.*?)\)/g;
            const matches = content.match(regex);
            return matches ? matches.length : 0;
        }

        async function connect() {
            if (!window.ethereum) return alert("请安装MetaMask！");
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const webProvider = new ethers.BrowserProvider(window.ethereum);
                const signer = await webProvider.getSigner();
                userAddr = await signer.getAddress();
                const net = await webProvider.getNetwork();
                currentChainId = "0x" + net.chainId.toString(16).toLowerCase();
                const switcher = document.getElementById('netSwitcher');
                if (switcher) switcher.value = currentChainId;
                updateUI();
                checkNetStatus();
            } catch (error) { console.error("Connection failed:", error); }
        }

        function showView(name) {
            lastView = name;
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('view-active'));
            document.querySelectorAll('#navMenu button').forEach(b => b.classList.remove('nav-link-active'));
            const targetView = document.getElementById(`view-${name}`);
            const targetBtn = document.getElementById(`nav-${name}`);
            if (targetView) targetView.classList.add('view-active');
            if (targetBtn) targetBtn.classList.add('nav-link-active');

            if (name === 'dashboard') loadAggregatedFeed(1);
            if (name === 'gallery') loadGallery(1);
            if (name === 'history') loadMyHistory(1);
            if (name === 'admin') loadAdminPanel();
        }

        function goBack() { if (lastView === 'post') showView('gallery'); else showView(lastView); }

        function parsePost(p, chainId) {
            try {
                const base = {
                    id: p.id || p[0], title: p.title || p[1], content: p.content || p[2], 
                    author: p.author || p[3], authorName: p.authorName || p[4], 
                    createdAt: Number(p.createdAt || p[5]), updatedAt: Number(p.updatedAt || p[6]), 
                    chainLabel: p.chainLabel || p[7], exists: p.exists !== undefined ? p.exists : p[8],
                    sourceId: chainId
                };
                if (isV6(chainId)) {
                    base.coverImageUrl = p.coverImageUrl || p[9] || "";
                    base.imageCount = p.imageCount || p[10] || 0;
                } else {
                    base.coverImageUrl = extractImageFromMarkdown(base.content);
                    base.imageCount = countImagesInMarkdown(base.content);
                }
                if (isV6(chainId) && !base.coverImageUrl) base.coverImageUrl = extractImageFromMarkdown(base.content);
                if (isV6(chainId) && base.imageCount === 0) base.imageCount = countImagesInMarkdown(base.content);
                return base;
            } catch (e) { return null; }
        }

        async function loadGallery(page) {
            const container = document.getElementById('galleryFeed');
            container.innerHTML = `<div class="col-span-full py-20 text-center animate-pulse font-bold text-pink-300">正在搜寻全宇宙的美图...</div>`;
            const pool = await fetchAggregatedPosts();
            const galleryPool = pool.filter(p => p.coverImageUrl || p.imageCount > 0);
            const start = (page - 1) * PAGE_SIZE;
            const final = galleryPool.slice(start, start + PAGE_SIZE);
            if (final.length === 0) container.innerHTML = `<div class="col-span-full text-center text-slate-400 py-10">暂无图片内容，去发布一个吧！</div>`;
            else container.innerHTML = final.map(p => renderGalleryCard(p)).join('');
            renderPagination('gallery-pagination', page, galleryPool.length > start + PAGE_SIZE, loadGallery);
        }

        function renderGalleryCard(p) {
            const net = NETWORKS[p.sourceId];
            const imgUrl = p.coverImageUrl || "https://placehold.co/600x800/f1f5f9/94a3b8?text=No+Image";
            const countTag = p.imageCount > 0 ? `[${p.imageCount}P]` : '';
            return `<div class="gallery-card group" onclick="goDetail('${p.sourceId}', ${p.id})"><img src="${imgUrl}" class="gallery-img" loading="lazy" alt="${p.title}" onerror="this.src='https://placehold.co/600x800/f1f5f9/94a3b8?text=Error'"><div class="gallery-overlay"><div class="gallery-title">${p.title}</div><div class="gallery-meta"><span>${countTag}</span><span class="gallery-badge bg-${net.theme.replace('theme-', 'indigo-')}">${net.name}</span></div></div></div>`;
        }

        async function fetchAggregatedPosts() {
            let pool = [];
            const tasks = activeFilters.map(async (id) => {
                if (!NETWORKS[id] || !NETWORKS[id].proxy.startsWith('0x')) return [];
                try {
                    const provider = new ethers.JsonRpcProvider(NETWORKS[id].rpc);
                    const contract = new ethers.Contract(NETWORKS[id].proxy, getABI(id), provider);
                    const posts = await contract.getPaginatedPosts(1, 50); 
                    return posts.map(rp => parsePost(rp, id));
                } catch (e) { return []; }
            });
            const results = await Promise.all(tasks);
            results.forEach(list => pool = pool.concat(list.filter(p => p && p.exists)));
            pool.sort((a, b) => b.createdAt - a.createdAt);
            return pool;
        }

        async function loadAggregatedFeed(page) {
            const container = document.getElementById('globalFeed');
            container.innerHTML = `<div class="col-span-full py-10 text-center animate-pulse font-bold text-slate-400">跨链同步中...</div>`;
            const pool = await fetchAggregatedPosts();
            
            // 修改点：使用 PAGE_SIZE (12) 代替原来的 10
            const start = (page - 1) * PAGE_SIZE;
            const final = pool.slice(start, start + PAGE_SIZE);
            
            container.innerHTML = final.map(p => renderCard(p)).join('') || "暂无内容。";
            renderPagination('dashboard-pagination', page, pool.length > start + PAGE_SIZE, loadAggregatedFeed);
        }

        function renderCard(p) {
             const net = NETWORKS[p.sourceId];
             if (!net) return '';
             return `<div class="bg-white border rounded-2xl p-6 hover:shadow-lg transition card-${net.theme}"><div class="flex justify-between items-start mb-3"><span class="text-[9px] font-black px-2 py-0.5 rounded tag-${net.theme}">${net.name} #${p.id}</span></div><h3 class="text-lg font-black mb-4 line-clamp-1">${p.title}</h3><div class="flex justify-between items-center pt-4 border-t"><span class="text-xs font-black text-${net.theme}">@${p.authorName}</span><button onclick="goDetail('${p.sourceId}', ${p.id})" class="text-xs font-bold text-indigo-600">详情 →</button></div></div>`;
        }

        async function handlePost() {
            const t = document.getElementById('postTitle').value;
            const c = document.getElementById('postContent').value;
            let cover = document.getElementById('coverUrl').value.trim();
            if (!t || !c) return alert("标题和内容不能为空");
            const postBtn = document.getElementById('postBtn');
            postBtn.disabled = true; postBtn.innerText = "正在上链...";
            try {
                const abi = getABI(currentChainId);
                const contract = new ethers.Contract(NETWORKS[currentChainId].proxy, abi, await (new ethers.BrowserProvider(window.ethereum)).getSigner());
                let tx;
                if (isV6(currentChainId)) {
                    const imgCount = countImagesInMarkdown(c);
                    if (!cover && imgCount > 0) cover = extractImageFromMarkdown(c);
                    tx = await contract.createPost(t, c, cover, imgCount);
                } else {
                    tx = await contract.createPost(t, c);
                }
                await tx.wait();
                alert("发布成功！");
                showView('gallery');
            } catch(e) { alert("发布失败: " + e.message); } finally { postBtn.disabled = false; postBtn.innerText = "广播存证"; }
        }

        async function goDetail(netId, id) {
            showView('post');
            const container = document.getElementById('detailContainer');
            container.innerHTML = "解析中...";
            const net = NETWORKS[netId];
            try {
                const provider = new ethers.JsonRpcProvider(net.rpc);
                const contract = new ethers.Contract(net.proxy, getABI(netId), provider);
                const p = await contract.posts(id);
                const post = parsePost(p, netId);
                const created = new Date(post.createdAt * 1000).toLocaleString();
                const isAuthor = userAddr && userAddr.toLowerCase() === post.author.toLowerCase();
                
                // 修改点：加入了编辑按钮 (Edit)
                container.innerHTML = `
                    <div class="mb-6 flex justify-between items-center">
                        <span class="tag-${net.theme} px-3 py-1 rounded-lg font-black text-[10px] uppercase">${net.name}</span>
                        <div class="flex items-center gap-2">
                             ${isAuthor ? `<button onclick="goEdit('${netId}', ${id})" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-xs font-bold transition">编辑</button>` : ''}
                            ${isAuthor ? `<button onclick="handleDelete('${netId}', ${id})" class="bg-rose-500 hover:bg-rose-600 text-white px-3 py-1 rounded text-xs font-bold transition">删除</button>` : ''}
                        </div>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-black mb-8 leading-tight text-slate-800">${post.title}</h1>
                    <div class="prose prose-lg max-w-none text-slate-700 mb-12">${marked.parse(post.content)}</div>
                    <div class="border-t pt-8 flex justify-between items-end"><div><div class="font-black text-xl text-${net.theme}">@${post.authorName}</div><div class="text-xs text-slate-400 mt-1">${created}</div></div><div class="text-xs font-mono text-slate-300">ID: ${post.id}</div></div>`;
            } catch (e) { container.innerHTML = "加载失败。"; console.error(e); }
        }
        
        // --- 新增：跳转编辑页逻辑 ---
        async function goEdit(netId, postId) {
            showView('edit');
            const net = NETWORKS[netId];
            try {
                const provider = new ethers.JsonRpcProvider(net.rpc);
                const contract = new ethers.Contract(net.proxy, getABI(netId), provider);
                const p = await contract.posts(postId);
                const post = parsePost(p, netId);

                document.getElementById('editPostId').value = postId;
                document.getElementById('editPostNetId').value = netId;
                document.getElementById('editTitle').value = post.title;
                document.getElementById('editContent').value = post.content;
                
                // V6 适配：显示/隐藏封面输入框，并填充原有数据
                const v6Fields = document.getElementById('edit-v6-fields');
                if (isV6(netId)) {
                    v6Fields.classList.remove('hidden');
                    document.getElementById('editCoverUrl').value = post.coverImageUrl || "";
                } else {
                    v6Fields.classList.add('hidden');
                }
            } catch (e) { alert("加载帖子内容失败!"); goBack(); }
        }

        // --- 修改：更新帖子逻辑 (V6 适配) ---
        async function handleUpdate() { 
            const postId = document.getElementById('editPostId').value;
            const netId = document.getElementById('editPostNetId').value;
            const title = document.getElementById('editTitle').value;
            const content = document.getElementById('editContent').value;
            let cover = document.getElementById('editCoverUrl').value.trim();

            if (currentChainId !== netId) return alert(`请切换到 ${NETWORKS[netId].name} 网络`);

            try {
                const contract = new ethers.Contract(NETWORKS[netId].proxy, getABI(netId), await (new ethers.BrowserProvider(window.ethereum)).getSigner());
                let tx;
                
                if (isV6(netId)) {
                    // V6 更新：带上封面和重新计算的图片数
                    const count = countImagesInMarkdown(content);
                    // 如果封面为空但有图，自动抓第一张
                    if (!cover && count > 0) cover = extractImageFromMarkdown(content);
                    tx = await contract.updatePost(postId, title, content, cover, count);
                } else {
                    // V5 更新
                    tx = await contract.updatePost(postId, title, content);
                }
                
                await tx.wait();
                alert("更新成功!"); 
                goDetail(netId, postId); 
            } catch (e) { alert("更新失败: " + e.message); } 
        }

        async function handleDelete(netId, postId) { 
            if (!confirm("确定删除？")) return; 
            if (currentChainId !== netId) return alert(`请切换网络`);
            try {
                const contract = new ethers.Contract(NETWORKS[netId].proxy, getABI(netId), await (new ethers.BrowserProvider(window.ethereum)).getSigner());
                await (await contract.deletePost(postId)).wait();
                alert("删除成功"); 
                goBack();
            } catch (e) { alert("删除失败"); } 
        }

        function checkNetStatus() {
            const alertEl = document.getElementById('netAlert');
            const net = NETWORKS[currentChainId];
            const v6Fields = document.getElementById('v6-fields');
            if (net) {
                alertEl.className = `mb-4 p-4 rounded-xl text-center text-xs font-black tag-${net.theme}`;
                if (isV6(currentChainId)) {
                    alertEl.innerHTML = `当前接入 V6 网络：${net.name} <span class="ml-2 bg-pink-500 text-white px-2 py-0.5 rounded-full text-[10px]">Gallery Ready</span>`;
                    v6Fields.classList.remove('hidden');
                } else {
                    alertEl.innerHTML = `当前接入 V5 网络：${net.name}`;
                    v6Fields.classList.add('hidden');
                }
                syncStatus(net);
            } else { alertEl.innerText = `请切换网络`; }
        }

        async function syncStatus(net) {
            try {
                const contract = new ethers.Contract(net.proxy, ABI, await (new ethers.BrowserProvider(window.ethereum)).getSigner());
                const user = await contract.users(userAddr);
                const owner = await contract.owner();
                document.getElementById('userName').innerText = user.isRegistered ? "@" + user.username : "未注册";
                document.getElementById('userAvatar').innerText = user.isRegistered ? user.username.charAt(0).toUpperCase() : '?';
                document.getElementById('regArea').classList.toggle('hidden', user.isRegistered);
                document.getElementById('createArea').classList.toggle('hidden', !user.isRegistered);
                document.getElementById('nav-admin').classList.toggle('hidden', userAddr.toLowerCase() !== owner.toLowerCase());
            } catch (e) { console.error("Sync status failed", e); }
        }

        function renderFilterUI() { document.getElementById('filterTags').innerHTML = Object.keys(NETWORKS).map(id => `<button onclick="toggleFilter('${id}')" id="tag-${NETWORKS[id].theme}" class="text-[9px] font-black px-3 py-1 rounded-lg tag-${NETWORKS[id].theme} border" style="opacity: ${activeFilters.includes(id) ? '1' : '0.3'}">${NETWORKS[id].name}</button>`).join(''); }
        function renderNetworkSwitcher() { const switcher = document.getElementById('netSwitcher'); let options = '<option value="">切换网络...</option>'; for (const id in NETWORKS) { options += `<option value="${id}">${NETWORKS[id].name}</option>`; } switcher.innerHTML = options; }
        function toggleFilter(id) { const btn = document.getElementById(`tag-${NETWORKS[id].theme}`); const index = activeFilters.indexOf(id); if (index > -1) { activeFilters.splice(index, 1); btn.style.opacity = "0.3"; } else { activeFilters.push(id); btn.style.opacity = "1"; } if (lastView === 'gallery') loadGallery(1); else loadAggregatedFeed(1); }
        async function switchNetwork(id) { if (!id || !window.ethereum) return; try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: id }], }); } catch (error) { if (error.code === 4902) { const net = NETWORKS[id]; await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: id, chainName: net.name, rpcUrls: [net.rpc] }], }); } } }
        function goHome() { window.history.pushState({}, document.title, window.location.pathname); showView('dashboard'); }
        function renderPagination(containerId, current, hasNext, callback) { const container = document.getElementById(containerId); if (!container) return; container.innerHTML = `<button onclick="${callback.name}(${current - 1})" ${current === 1 ? 'disabled' : ''} class="pagination-btn">←</button><span class="text-xs font-black text-slate-400 self-center">PAGE ${current}</span><button onclick="${callback.name}(${current + 1})" ${!hasNext ? 'disabled' : ''} class="pagination-btn">→</button>`; }
        function updateUI() { document.getElementById('connectBtn').classList.add('hidden'); document.getElementById('userInfo').classList.remove('hidden'); document.getElementById('nav-history').classList.remove('hidden'); }
        
        async function loadMyHistory(page) { 
             const list = document.getElementById('historyList'); 
             const net = NETWORKS[currentChainId];
             if (!net || !userAddr) return list.innerHTML = "请连接钱包";
             try {
                 const provider = new ethers.JsonRpcProvider(net.rpc);
                 const contract = new ethers.Contract(net.proxy, getABI(currentChainId), provider);
                 const ids = await contract.getPostIdsByAddress(userAddr);
                 const reversedIds = [...ids].reverse();
                 const start = (page - 1) * PAGE_SIZE;
                 const targetIds = reversedIds.slice(start, start + PAGE_SIZE);
                 const tasks = targetIds.map(id => contract.posts(id));
                 const rawPosts = await Promise.all(tasks);
                 const posts = rawPosts.map(p => parsePost(p, currentChainId));
                 list.innerHTML = posts.map(p => renderCard(p)).join('');
                 renderPagination('history-pagination', page, reversedIds.length > start + PAGE_SIZE, loadMyHistory);
             } catch(e) { console.error(e); }
        }
        
        async function loadAdminPanel() { /* 与原版一致，省略以节省长度 */ }
        async function handleRegister() { const n = document.getElementById('regInput').value; const contract = new ethers.Contract(NETWORKS[currentChainId].proxy, getABI(currentChainId), await (new ethers.BrowserProvider(window.ethereum)).getSigner()); await (await contract.register(n)).wait(); window.location.reload(); }
        async function handleBan(status) { const addr = document.getElementById('targetAddr').value; const net = NETWORKS[currentChainId]; try { const contract = new ethers.Contract(net.proxy, ABI, await (new ethers.BrowserProvider(window.ethereum)).getSigner()); await (await contract.setBannedStatus(addr, status)).wait(); alert("权限已同步！"); loadAdminPanel(); } catch(e) { alert("失败"); } }
    </script>
</body>
</html>
