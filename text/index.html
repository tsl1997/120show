<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniVerse Protocol | 跨链存证中心 v6.8</title>
    <!-- 配置文件 (必须存在 config.js) -->
    <script src="config.js"></script> 
    
    <!-- 国内 CDN 加速 -->
    <script src="https://cdn.staticfile.org/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.staticfile.org/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* 基础动画与样式 */
        .view-section { display: none; }
        .view-active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-link-active { background: #4f46e5 !important; color: white !important; }
        
        /* 自定义复选框样式 */
        .chain-checkbox:checked + div {
            background-color: #eef2ff;
            border-color: #6366f1;
            color: #4338ca;
            font-weight: 800;
        }
        .chain-checkbox:checked + div::after {
            content: '✓';
            position: absolute;
            top: -6px;
            right: -6px;
            background: #4f46e5;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        /* 标签颜色主题 */
        .tag-theme-1 { background:#eef2ff; color:#4338ca; border:1px solid #c7d2fe; }
        .tag-theme-2 { background:#ecfdf5; color:#059669; border:1px solid #a7f3d0; } 
        .tag-theme-3 { background:#fffbeb; color:#d97706; border:1px solid #fde68a; }
        .tag-theme-4 { background:#fef2f2; color:#dc2626; border:1px solid #fecaca; }
        .tag-theme-5 { background:#f3e8ff; color:#8b5cf6; border:1px solid #ddd6fe; }
        .tag-theme-6 { background:#fff5e6; color:#f97316; border:1px solid #fed7aa; }
        .tag-theme-7 { background:#f0f9ff; color:#0ea5e9; border:1px solid #bae6fd; }
        .tag-theme-8 { background:#f0fdfa; color:#0d9488; border:1px solid #99f6e4; }
        .tag-theme-9 { background:#fefce8; color:#ca8a04; border:1px solid #fef08a; }
        .tag-theme-10 { background:#faf5ff; color:#9333ea; border:1px solid #e9d5ff; }
        .card-theme-1 { border-left: 4px solid #4338ca; }
        .card-theme-2 { border-left: 4px solid #059669; }
        .card-theme-3 { border-left: 4px solid #d97706; }
        .card-theme-4 { border-left: 4px solid #dc2626; }
        .card-theme-5 { border-left: 4px solid #8b5cf6; }
        .card-theme-6 { border-left: 4px solid #f97316; }
        .card-theme-7 { border-left: 4px solid #0ea5e9; }
        .card-theme-8 { border-left: 4px solid #0d9488; }
        .card-theme-9 { border-left: 4px solid #ca8a04; }
        .card-theme-10 { border-left: 4px solid #9333ea; }

        /* --- 核心修复：看图模式卡片 (回归 v6.6 经典样式) --- */
        .gallery-card {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background: #f1f5f9;
            aspect-ratio: 3/4; 
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .gallery-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .gallery-img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform 0.5s ease; 
        }
        .gallery-card:hover .gallery-img { 
            transform: scale(1.05); 
        }
        .gallery-overlay {
            position: absolute; 
            inset: 0;
            /* 经典的底部渐变黑蒙版 */
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 60%);
            opacity: 0; 
            transition: opacity 0.3s ease;
            display: flex; 
            flex-direction: column; 
            justify-content: flex-end; 
            padding: 16px;
        }
        /* 移动端常显，桌面端悬停显示 */
        @media (max-width: 767px) { .gallery-overlay { opacity: 1; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 50%); } }
        @media (min-width: 768px) { .gallery-card:hover .gallery-overlay { opacity: 1; } }

        .gallery-title {
            color: white;
            font-weight: 900;
            font-size: 1rem;
            line-height: 1.4;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); /* 文字投影增强可读性 */
        }
        .gallery-meta {
            color: rgba(255,255,255,0.95);
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .gallery-badge {
            background: #4f46e5;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* 分页按钮 */
        .pagination-btn { 
            background: white; 
            border: 1px solid #e2e8f0; 
            padding: 8px 20px; 
            border-radius: 10px; 
            font-weight: bold; 
            font-size: 14px; 
            transition: all 0.2s; 
            color: #475569;
        }
        .pagination-btn:hover:not(:disabled) { 
            background: #f8fafc; 
            border-color: #cbd5e1; 
            color: #0f172a;
        }
        .pagination-btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">

    <!-- 导航栏 -->
    <nav class="bg-white border-b sticky top-0 z-50 px-4 py-3 shadow-sm">
        <div class="container mx-auto flex flex-wrap justify-between items-center gap-y-3">
            <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
                <div class="w-9 h-9 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-black text-xl">Ω</div>
                <h1 class="font-black text-xl tracking-tighter">OmniVerse <span class="text-indigo-600 text-sm align-top">v6.8</span></h1>
            </div>
            
            <!-- 钱包 & 网络 -->
            <div class="flex items-center gap-2 lg:order-3">
                <select id="netSwitcher" onchange="switchNetwork(this.value)" class="bg-slate-50 border rounded-lg px-2 py-2 text-xs font-bold outline-none max-w-[120px]"></select>
                <button id="connectBtn" onclick="connect()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-sm hover:bg-indigo-700 transition">连接钱包</button>
                <div id="userInfo" class="hidden flex items-center gap-2 bg-white border p-1 pr-3 rounded-lg">
                    <div id="userAvatar" class="w-7 h-7 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600 font-black">?</div>
                    <span id="userName" class="text-xs font-bold whitespace-nowrap"></span>
                </div>
            </div>

            <!-- 菜单 -->
            <div class="w-full lg:w-auto lg:flex-1 lg:order-2">
                 <div id="navMenu" class="flex items-center bg-slate-100 p-1 rounded-xl w-full justify-center gap-1 md:gap-4 overflow-x-auto">
                    <button onclick="showView('dashboard')" id="nav-dashboard" class="px-4 py-1.5 rounded-lg text-sm font-bold text-slate-500 hover:text-indigo-600 transition whitespace-nowrap">大厅</button>
                    <button onclick="showView('gallery')" id="nav-gallery" class="px-4 py-1.5 rounded-lg text-sm font-bold text-pink-500 hover:text-pink-600 transition whitespace-nowrap">看图</button>
                    <button onclick="showView('create')" id="nav-create" class="px-4 py-1.5 rounded-lg text-sm font-bold text-slate-500 hover:text-indigo-600 transition whitespace-nowrap">发布</button>
                    <button onclick="showView('history')" id="nav-history" class="hidden px-4 py-1.5 rounded-lg text-sm font-bold text-slate-500 hover:text-indigo-600 transition whitespace-nowrap">记录</button>
                    <button onclick="showView('admin')" id="nav-admin" class="hidden px-4 py-1.5 rounded-lg text-sm font-bold text-rose-500 hover:text-rose-600 transition whitespace-nowrap">管理</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto max-w-6xl px-4 py-6">
        
        <!-- 1. 大厅 View -->
        <div id="view-dashboard" class="view-section space-y-6">
            
            <!-- 标签栏布局: 主网/测试网分离 -->
            <div class="bg-white p-6 rounded-2xl border shadow-sm">
                <!-- 主网行 -->
                <div class="flex items-start gap-4 mb-4 border-b pb-4 border-slate-100">
                    <span class="text-xs font-black text-slate-400 w-12 pt-2 uppercase tracking-wide">主网</span>
                    <div id="mainnet-filters" class="flex flex-wrap gap-3"></div>
                </div>
                <!-- 测试网行 -->
                <div class="flex items-start gap-4">
                    <span class="text-xs font-black text-slate-400 w-12 pt-2 uppercase tracking-wide">测试网</span>
                    <div id="testnet-filters" class="flex flex-wrap gap-3"></div>
                </div>
            </div>

            <div id="globalFeed" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>
            
            <div class="flex justify-center items-center gap-4 pt-6 pb-12">
                <button onclick="changePage(-1)" id="prevBtn" class="pagination-btn" disabled>上一页</button>
                <span id="pageIndicator" class="text-sm font-black text-slate-400">PAGE 1</span>
                <button onclick="changePage(1)" id="nextBtn" class="pagination-btn">下一页</button>
            </div>
        </div>

        <!-- 2. 看图 View -->
        <div id="view-gallery" class="view-section">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-black italic text-pink-600 flex items-center gap-2">
                        Visual Gallery 
                        <span class="text-xs bg-pink-100 text-pink-600 px-2 py-0.5 rounded-md not-italic border border-pink-200">Tempo Network</span>
                    </h2>
                    <p class="text-xs text-slate-400 mt-1 font-bold">极速模式：直连 Tempo 节点</p>
                </div>
            </div>
            <div id="galleryFeed" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6"></div>
            <div class="flex justify-center items-center gap-4 pt-10 pb-12">
                <button onclick="changeGalleryPage(-1)" id="galPrevBtn" class="pagination-btn" disabled>← 上一页</button>
                <span id="galPageIndicator" class="text-sm font-black text-slate-400">PAGE 1</span>
                <button onclick="changeGalleryPage(1)" id="galNextBtn" class="pagination-btn">下一页 →</button>
            </div>
        </div>

        <!-- 3. 发布 View -->
        <div id="view-create" class="view-section max-w-xl mx-auto">
            <div id="netAlert" class="mb-4 p-4 rounded-xl text-center text-xs font-black"></div>
            
            <div id="regArea" class="hidden bg-indigo-600 p-8 rounded-3xl text-white mb-6 shadow-xl">
                <h2 class="text-2xl font-black mb-4">注册链上身份</h2>
                <p class="text-indigo-200 text-xs mb-4">在当前网络注册一个唯一的昵称，开始您的创作之旅。</p>
                <input type="text" id="regInput" placeholder="输入昵称 (例如: Alice)..." class="w-full p-4 rounded-xl text-slate-900 font-bold mb-4 outline-none">
                <button onclick="handleRegister()" class="w-full bg-white text-indigo-600 py-4 rounded-xl font-black hover:bg-slate-100 transition">立即激活</button>
            </div>

            <div id="createArea" class="bg-white border p-8 rounded-3xl shadow-sm">
                <h3 class="text-lg font-black mb-4">发布新存证</h3>
                <input type="text" id="postTitle" placeholder="标题" class="w-full p-4 bg-slate-50 rounded-xl mb-4 font-bold outline-none border focus:border-indigo-500 transition">
                
                <!-- V6 特性 -->
                <div id="v6-fields" class="hidden mb-4 p-4 bg-pink-50 rounded-xl border border-pink-100">
                    <label class="block text-xs font-bold text-pink-600 mb-2">封面 URL (可选)</label>
                    <input type="text" id="coverUrl" placeholder="https://..." class="w-full p-3 bg-white rounded-lg text-sm outline-none border focus:border-pink-300 transition">
                    <p class="text-[10px] text-pink-400 mt-1">* 留空则自动从内容中抓取第一张图</p>
                </div>

                <textarea id="postContent" placeholder="Markdown 内容 (支持图片: ![desc](url))..." class="w-full p-4 bg-slate-50 rounded-xl h-48 mb-6 font-medium outline-none border focus:border-indigo-500 transition"></textarea>
                <button id="postBtn" onclick="handlePost()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black hover:bg-slate-800 transition shadow-lg">广播上链</button>
            </div>
        </div>

        <!-- 4. 详情 View -->
        <div id="view-post" class="view-section">
            <div id="detailContainer" class="bg-white border p-8 md:p-12 rounded-[2rem] shadow-sm max-w-4xl mx-auto"></div>
            <button onclick="goBack()" class="mt-8 text-slate-400 font-bold block mx-auto hover:text-indigo-600 transition">← 返回列表</button>
        </div>

        <!-- 5. 历史记录 View (带分页) -->
        <div id="view-history" class="view-section space-y-6">
            <h2 class="text-2xl font-black border-b pb-4 italic">My Footprints (当前链)</h2>
            <div id="historyList" class="grid gap-4 md:grid-cols-2"></div>
            <div class="flex justify-center items-center gap-4 pt-6 pb-12">
                <button onclick="changeHistoryPage(-1)" id="histPrevBtn" class="pagination-btn" disabled>← 上一页</button>
                <span id="histPageIndicator" class="text-sm font-black text-slate-400">PAGE 1</span>
                <button onclick="changeHistoryPage(1)" id="histNextBtn" class="pagination-btn" disabled>下一页 →</button>
            </div>
        </div>

        <!-- 6. 编辑 View -->
        <div id="view-edit" class="view-section max-w-xl mx-auto">
            <div class="bg-white border p-8 rounded-3xl shadow-sm">
                <h2 class="text-2xl font-black mb-6">编辑帖子</h2>
                <input type="hidden" id="editPostId"><input type="hidden" id="editPostNetId">
                <input type="text" id="editTitle" placeholder="标题" class="w-full p-4 bg-slate-50 rounded-xl mb-4 font-bold outline-none border">
                
                <!-- 编辑时的 V6 字段 -->
                <div id="edit-v6-fields" class="hidden mb-4 p-4 bg-pink-50 rounded-xl border border-pink-100">
                    <label class="block text-xs font-bold text-pink-600 mb-2">修改封面 (V6)</label>
                    <input type="text" id="editCoverUrl" class="w-full p-3 bg-white rounded-lg text-sm outline-none border">
                </div>

                <textarea id="editContent" placeholder="内容..." class="w-full p-4 bg-slate-50 rounded-xl h-48 mb-6 font-medium outline-none border"></textarea>
                <div class="flex gap-4">
                    <button onclick="goBack()" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-xl font-bold">取消</button>
                    <button onclick="handleUpdate()" class="flex-[2] bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg">更新</button>
                </div>
            </div>
        </div>

        <!-- 7. 管理 View -->
        <div id="view-admin" class="view-section space-y-6">
            <div class="bg-amber-50 p-8 rounded-[2rem] border border-amber-100">
                <h3 class="text-xl font-black text-amber-900 mb-4">用户权限管理</h3>
                <div class="flex gap-2">
                    <input type="text" id="targetAddr" placeholder="0x..." class="flex-1 p-4 rounded-xl outline-none border font-mono text-sm bg-white">
                    <button onclick="handleBan(true)" class="bg-rose-500 text-white px-6 py-2 rounded-xl font-bold">封禁</button>
                    <button onclick="handleBan(false)" class="bg-emerald-500 text-white px-6 py-2 rounded-xl font-bold">解封</button>
                </div>
            </div>
            <div class="bg-white border rounded-[2rem] p-8">
                <h4 class="font-black mb-6">已注册用户列表 (当前链)</h4>
                <div id="userList" class="overflow-x-auto"></div>
            </div>
        </div>

    </main>

    <script>
        // --- 核心配置 ---
        const MAINNET_IDS = ['0x64', '0xcc']; // Gnosis, opBNB
        const TESTNET_IDS = ['0xa5bd', '0xaa36a7', '0xc488', '0x88bb0', '0x15eb', '0x61', '0x4cef52', '0x164ce', '0x14a34'];
        
        // 默认激活: 主网全选 + Tempo, Sepolia, Somnia
        const DEFAULT_ACTIVE = ['0x64', '0xcc', '0xa5bd', '0xaa36a7', '0xc488']; 
        
        // Gallery 专用链
        const GALLERY_CHAIN = '0xa5bd'; 

        // --- 完整 ABI ---
        const V6_ABI = [
            "function register(string _username) public",
            "function createPost(string _title, string _content, string _coverImageUrl, uint8 _imageCount) public",
            "function updatePost(uint256 _id, string _newTitle, string _newContent, string _newCoverImageUrl, uint8 _newImageCount) public",
            "function deletePost(uint256 _id) public",
            "function getPostCount() view returns (uint256)",
            "function getPaginatedPosts(uint256 _page, uint256 _pageSize) view returns (tuple(uint256 id, string title, string content, address author, string authorName, uint256 createdAt, uint256 updatedAt, string chainLabel, bool exists, string coverImageUrl, uint8 imageCount)[])",
            "function users(address) view returns (string username, bool isBanned, bool isRegistered, address userAddress)",
            "function posts(uint256) view returns (uint256 id, string title, string content, address author, string authorName, uint256 createdAt, uint256 updatedAt, string chainLabel, bool exists, string coverImageUrl, uint8 imageCount)",
            "function getPostIdsByAddress(address _user) view returns (uint256[])",
            "function getUserCount() view returns (uint256)",
            "function allRegisteredUsers(uint256) view returns (address)",
            "function setBannedStatus(address _user, bool _status) public",
            "function owner() view returns (address)"
        ];

        // 状态变量
        let activeChains = [...DEFAULT_ACTIVE];
        let userAddr, currentChainId;
        let lastView = 'dashboard';
        
        // 分页状态
        let currentPage = 1;
        let currentGalleryPage = 1;
        let currentHistoryPage = 1;
        let historyIdsCache = []; // 缓存历史ID以便分页

        const THEMES = ['theme-1', 'theme-2', 'theme-3', 'theme-4', 'theme-5', 'theme-6', 'theme-7', 'theme-8', 'theme-9', 'theme-10'];

        // --- 初始化 ---
        window.onload = async () => {
            marked.setOptions({ breaks: true, gfm: true });
            
            // 初始化主题颜色
            Object.keys(NETWORKS).forEach((id, index) => { NETWORKS[id].theme = THEMES[index % THEMES.length]; });
            
            renderChainSelectors();
            renderNetworkSwitcher();
            
            const urlParams = new URLSearchParams(window.location.search);
            const netId = urlParams.get('netId'), postId = urlParams.get('postId');
            
            if (netId && postId) { 
                goDetail(netId, postId); 
            } else { 
                showView('dashboard'); 
            }
            
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', () => window.location.reload());
                // 自动连接
                const acc = await window.ethereum.request({ method: 'eth_accounts' });
                if (acc.length > 0) connect();
            }
        };

        // --- 核心逻辑: 链选择 UI ---
        function renderChainSelectors() {
            const createCheckbox = (id) => {
                if (!NETWORKS[id]) return '';
                const isChecked = activeChains.includes(id) ? 'checked' : '';
                return `
                <label class="relative cursor-pointer select-none group">
                    <input type="checkbox" class="chain-checkbox hidden" value="${id}" ${isChecked} onchange="toggleChain('${id}')">
                    <div class="px-3 py-1.5 border border-slate-200 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 hover:border-indigo-200 transition relative">
                        ${NETWORKS[id].name}
                    </div>
                </label>`;
            };

            document.getElementById('mainnet-filters').innerHTML = MAINNET_IDS.map(createCheckbox).join('');
            document.getElementById('testnet-filters').innerHTML = TESTNET_IDS.map(createCheckbox).join('');
        }

        function toggleChain(id) {
            if (activeChains.includes(id)) {
                activeChains = activeChains.filter(c => c !== id);
            } else {
                activeChains.push(id);
            }
            // 重新加载大厅数据
            currentPage = 1;
            loadDashboard(1);
        }

        // --- 核心逻辑: 数据加载 (按需模式) ---
        
        function showView(name) {
            lastView = name;
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('view-active'));
            document.querySelectorAll('#navMenu button').forEach(b => b.classList.remove('nav-link-active'));
            
            const targetView = document.getElementById(`view-${name}`);
            const targetBtn = document.getElementById(`nav-${name}`);
            if (targetView) targetView.classList.add('view-active');
            if (targetBtn) targetBtn.classList.add('nav-link-active');

            if (name === 'dashboard') loadDashboard(currentPage);
            if (name === 'gallery') loadGallery(currentGalleryPage);
            if (name === 'history') loadHistory(currentHistoryPage); // 带分页的加载
            if (name === 'admin') loadAdmin();
        }

        // 1. 大厅数据
        async function loadDashboard(page) {
            const container = document.getElementById('globalFeed');
            container.innerHTML = `<div class="col-span-full py-16 text-center animate-pulse text-slate-400 font-bold">正在从 ${activeChains.length} 个网络获取第 ${page} 页数据...</div>`;
            
            document.getElementById('pageIndicator').innerText = `PAGE ${page}`;
            document.getElementById('prevBtn').disabled = (page === 1);

            // 增加到 6，确保单链也能铺满 3列 x 2行
            const PER_CHAIN_LIMIT = 6; 
            
            const tasks = activeChains.map(async (chainId) => {
                const net = NETWORKS[chainId];
                if (!net) return [];
                try {
                    const provider = new ethers.JsonRpcProvider(net.rpc);
                    const contract = new ethers.Contract(net.proxy, V6_ABI, provider);
                    const posts = await contract.getPaginatedPosts(page, PER_CHAIN_LIMIT);
                    return posts.map(p => parsePost(p, chainId)).filter(p => p.exists);
                } catch (e) {
                    console.warn(`Skipping ${net.name} due to error or timeout.`);
                    return [];
                }
            });

            const results = await Promise.all(tasks);
            let merged = results.flat();
            merged.sort((a, b) => b.createdAt - a.createdAt);
            
            if (merged.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-slate-400 py-10">当前页无数据，请尝试翻页。</div>`;
            } else {
                container.innerHTML = merged.map(p => renderCard(p)).join('');
            }
        }

        function changePage(delta) {
            if (currentPage + delta < 1) return;
            currentPage += delta;
            loadDashboard(currentPage);
        }

        // 2. 看图数据 (单链 Tempo - 修复数量问题)
        async function loadGallery(page) {
            const container = document.getElementById('galleryFeed');
            container.innerHTML = `<div class="col-span-full py-20 text-center animate-pulse text-pink-400 font-bold">正在极速加载 Tempo 影像数据 (v6)...</div>`;
            
            document.getElementById('galPageIndicator').innerText = `PAGE ${page}`;
            document.getElementById('galPrevBtn').disabled = (page === 1);

            const net = NETWORKS[GALLERY_CHAIN];
            try {
                const provider = new ethers.JsonRpcProvider(net.rpc);
                const contract = new ethers.Contract(net.proxy, V6_ABI, provider);
                
                // 修复逻辑：请求 14 条数据，然后截取前 12 条。
                // 这样即使中间有 1-2 条帖子被删除了，前端也能展示满 12 张图。
                const FETCH_SIZE = 14; 
                const DISPLAY_SIZE = 12;

                const posts = await contract.getPaginatedPosts(page, FETCH_SIZE);
                let parsed = posts.map(p => parsePost(p, GALLERY_CHAIN)).filter(p => p.exists && (p.coverImageUrl || p.imageCount > 0));

                // 截取
                if (parsed.length > DISPLAY_SIZE) {
                    parsed = parsed.slice(0, DISPLAY_SIZE);
                }

                if (parsed.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center text-slate-400 py-10">本页无图片数据。</div>`;
                } else {
                    container.innerHTML = parsed.map(p => renderGalleryCard(p)).join('');
                }
            } catch (e) {
                container.innerHTML = `<div class="col-span-full text-center text-rose-500 py-10">加载失败，请检查网络连接。</div>`;
            }
        }

        function changeGalleryPage(delta) {
            if (currentGalleryPage + delta < 1) return;
            currentGalleryPage += delta;
            loadGallery(currentGalleryPage);
        }

        // 3. 历史记录 (增加分页功能)
        async function loadHistory(page = 1) {
            currentHistoryPage = page;
            const list = document.getElementById('historyList');
            
            document.getElementById('histPageIndicator').innerText = `PAGE ${page}`;
            document.getElementById('histPrevBtn').disabled = (page === 1);
            document.getElementById('histNextBtn').disabled = true; // 暂定，加载完再判断
            
            list.innerHTML = `<div class="col-span-full py-10 text-center text-slate-400">正在检索您的足迹...</div>`;
            
            if (!currentChainId || !userAddr) return list.innerHTML = `<div class="col-span-full text-center font-bold text-indigo-500">请先连接钱包</div>`;
            
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(NETWORKS[currentChainId].proxy, V6_ABI, await provider.getSigner());
                
                // 首次加载或刷新时获取 ID 列表
                if (historyIdsCache.length === 0 || page === 1) {
                    const ids = await contract.getPostIdsByAddress(userAddr);
                    // 倒序排列（新到旧）
                    historyIdsCache = [...ids].reverse();
                }

                if (historyIdsCache.length === 0) {
                    document.getElementById('histNextBtn').disabled = true;
                    return list.innerHTML = `<div class="col-span-full text-center text-slate-400">您在当前链上还没有发布过内容。</div>`;
                }

                // 客户端分页切片 (每页10条)
                const PAGE_SIZE = 10;
                const start = (page - 1) * PAGE_SIZE;
                const end = start + PAGE_SIZE;
                const pageIds = historyIdsCache.slice(start, end);

                // 更新下一页按钮状态
                document.getElementById('histNextBtn').disabled = (end >= historyIdsCache.length);

                const postPromises = pageIds.map(id => contract.posts(id));
                const rawPosts = await Promise.all(postPromises);
                const posts = rawPosts.map(p => parsePost(p, currentChainId));

                list.innerHTML = posts.map(p => renderCard(p)).join('');

            } catch(e) {
                list.innerHTML = `<div class="col-span-full text-center text-rose-500">加载失败: ${e.message}</div>`;
            }
        }

        function changeHistoryPage(delta) {
            if (currentHistoryPage + delta < 1) return;
            loadHistory(currentHistoryPage + delta);
        }

        // 4. 管理员面板
        async function loadAdmin() {
            const container = document.getElementById('userList');
            container.innerHTML = "加载中...";
            if (!currentChainId) return container.innerHTML = "请先连接钱包";

            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(NETWORKS[currentChainId].proxy, V6_ABI, await provider.getSigner());
                const count = await contract.getUserCount();
                
                let html = `<table class="w-full text-left text-xs"><thead><tr class="text-slate-400 border-b"><th class="pb-4">昵称</th><th class="pb-4">地址</th><th class="pb-4">状态</th></tr></thead><tbody>`;
                // 仅显示前 20 个用户防止卡顿
                const limit = Math.min(Number(count), 20);
                for(let i = 0; i < limit; i++) {
                    const addr = await contract.allRegisteredUsers(i);
                    const user = await contract.users(addr);
                    html += `<tr class="border-b"><td class="py-4 font-bold">@${user.username}</td><td class="py-4 font-mono text-slate-400 break-all">${addr}</td><td>${user.isBanned?'<span class="text-rose-500">已封禁</span>':'<span class="text-emerald-500">正常</span>'}</td></tr>`;
                }
                container.innerHTML = html + "</tbody></table>";
            } catch(e) {
                container.innerHTML = "无权限或加载失败";
            }
        }

        // --- 辅助函数 ---
        function parsePost(p, chainId) {
            const isV6 = (chainId === '0xa5bd'); 
            let cover = isV6 ? p.coverImageUrl : '';
            let count = isV6 ? Number(p.imageCount) : 0;
            
            if (!cover) {
                const match = p.content.match(/!\[.*?\]\((.*?)\)/);
                if (match) cover = match[1];
            }
            if (count === 0) {
                const matches = p.content.match(/!\[.*?\]\((.*?)\)/g);
                if (matches) count = matches.length;
            }

            return {
                id: Number(p.id),
                title: p.title,
                content: p.content,
                author: p.author,
                authorName: p.authorName,
                createdAt: Number(p.createdAt),
                sourceId: chainId,
                exists: p.exists,
                coverImageUrl: cover,
                imageCount: count
            };
        }

        function renderCard(p) {
            const net = NETWORKS[p.sourceId];
            return `<div class="bg-white border rounded-2xl p-6 hover:shadow-lg transition card-${net.theme}">
                <div class="flex justify-between items-start mb-3"><span class="text-[9px] font-black px-2 py-0.5 rounded tag-${net.theme}">${net.name} #${p.id}</span></div>
                <h3 class="text-lg font-black mb-4 line-clamp-1">${p.title}</h3>
                <div class="flex justify-between items-center pt-4 border-t"><span class="text-xs font-black text-${net.theme}">@${p.authorName}</span><button onclick="goDetail('${p.sourceId}', ${p.id})" class="text-xs font-bold text-indigo-600">详情 →</button></div>
            </div>`;
        }

        // 还原 v6.6 风格
        function renderGalleryCard(p) {
            const net = NETWORKS[p.sourceId];
            const imgUrl = p.coverImageUrl || "https://placehold.co/600x800/f1f5f9/94a3b8?text=No+Image";
            const countTag = p.imageCount > 0 ? `[${p.imageCount}P]` : '';
            
            // 左上角发布者 Badge (保持 v6.7 逻辑但微调位置)
            const authorBadge = `
                <div class="absolute top-2 left-2 z-10 pointer-events-none">
                    <span class="bg-black/40 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-md shadow-sm font-bold flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-pink-500 inline-block"></span>
                        @${p.authorName}
                    </span>
                </div>
            `;

            return `
            <div class="gallery-card group" onclick="goDetail('${p.sourceId}', ${p.id})">
                ${authorBadge}
                <img src="${imgUrl}" class="gallery-img" loading="lazy" alt="${p.title}" onerror="this.src='https://placehold.co/600x800/f1f5f9/94a3b8?text=Error'">
                <div class="gallery-overlay">
                    <div class="gallery-title">${p.title}</div>
                    <div class="gallery-meta">
                        <span>${countTag}</span>
                        <span class="gallery-badge bg-pink-500">${net.name}</span>
                    </div>
                </div>
            </div>`;
        }

        async function goDetail(netId, id) {
            showView('post');
            const container = document.getElementById('detailContainer');
            container.innerHTML = "加载中...";
            try {
                const net = NETWORKS[netId];
                const provider = new ethers.JsonRpcProvider(net.rpc);
                const contract = new ethers.Contract(net.proxy, V6_ABI, provider);
                const p = await contract.posts(id);
                const post = parsePost(p, netId);
                const isAuthor = userAddr && userAddr.toLowerCase() === post.author.toLowerCase();
                
                container.innerHTML = `
                    <div class="mb-6 flex justify-between items-center">
                        <span class="tag-${net.theme} px-3 py-1 rounded-lg font-black text-[10px] uppercase">${net.name}</span>
                        <div class="flex gap-2">
                             ${isAuthor ? `<button onclick="goEdit('${netId}', ${id})" class="bg-indigo-500 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-indigo-600 transition">编辑</button>` : ''}
                             ${isAuthor ? `<button onclick="handleDelete('${netId}', ${id})" class="bg-rose-500 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-rose-600 transition">删除</button>` : ''}
                        </div>
                    </div>
                    <h1 class="text-3xl font-black mb-8 text-slate-800 leading-tight">${post.title}</h1>
                    <div class="prose prose-lg max-w-none text-slate-700 mb-12">${marked.parse(post.content)}</div>
                    <div class="border-t pt-6 flex justify-between items-end">
                        <div><div class="font-black text-xl text-${net.theme}">@${post.authorName}</div><div class="text-xs text-slate-400 mt-1">${new Date(post.createdAt*1000).toLocaleString()}</div></div>
                        <div class="text-xs font-mono text-slate-300">ID: ${post.id}</div>
                    </div>`;
            } catch (e) { container.innerHTML = "读取失败"; }
        }

        // --- 交互功能 (编辑、发布、注册、删除) ---

        async function goEdit(netId, postId) {
            showView('edit');
            const net = NETWORKS[netId];
            try {
                const provider = new ethers.JsonRpcProvider(net.rpc);
                const contract = new ethers.Contract(net.proxy, V6_ABI, provider);
                const p = await contract.posts(postId);
                const post = parsePost(p, netId);

                document.getElementById('editPostId').value = postId;
                document.getElementById('editPostNetId').value = netId;
                document.getElementById('editTitle').value = post.title;
                document.getElementById('editContent').value = post.content;
                
                const v6Fields = document.getElementById('edit-v6-fields');
                if (netId === '0xa5bd') { // Only Tempo
                    v6Fields.classList.remove('hidden');
                    document.getElementById('editCoverUrl').value = post.coverImageUrl || "";
                } else {
                    v6Fields.classList.add('hidden');
                }
            } catch (e) { alert("无法加载数据"); goBack(); }
        }

        async function handleUpdate() {
            const postId = document.getElementById('editPostId').value;
            const netId = document.getElementById('editPostNetId').value;
            const title = document.getElementById('editTitle').value;
            const content = document.getElementById('editContent').value;
            const cover = document.getElementById('editCoverUrl').value;

            if (currentChainId !== netId) return alert(`请切换到 ${NETWORKS[netId].name} 网络`);

            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(NETWORKS[netId].proxy, V6_ABI, await provider.getSigner());
                let tx;
                if (netId === '0xa5bd') {
                    const count = (content.match(/!\[.*?\]\((.*?)\)/g) || []).length;
                    tx = await contract.updatePost(postId, title, content, cover, count);
                } else {
                    tx = await contract.updatePost(postId, title, content);
                }
                await tx.wait();
                alert("更新成功");
                goDetail(netId, postId);
            } catch (e) { alert("更新失败: " + e.message); }
        }

        async function handlePost() {
            if (!currentChainId) return alert("请先连接钱包");
            const t = document.getElementById('postTitle').value;
            const c = document.getElementById('postContent').value;
            const cover = document.getElementById('coverUrl').value || '';
            if (!t || !c) return alert("请填写标题和内容");
            
            const btn = document.getElementById('postBtn');
            btn.innerText = "广播中..."; btn.disabled = true;
            
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(NETWORKS[currentChainId].proxy, V6_ABI, await provider.getSigner());
                
                let tx;
                // V6 Logic for Tempo
                if (currentChainId === '0xa5bd') {
                    const imgCount = (c.match(/!\[.*?\]\((.*?)\)/g) || []).length;
                    tx = await contract.createPost(t, c, cover, imgCount);
                } else {
                    tx = await contract.createPost(t, c);
                }
                await tx.wait();
                alert("发布成功！");
                if (currentChainId === '0xa5bd') showView('gallery'); else showView('dashboard');
            } catch (e) {
                alert("发布失败: " + e.message);
            } finally {
                btn.innerText = "广播上链"; btn.disabled = false;
            }
        }

        async function handleRegister() {
            const n = document.getElementById('regInput').value;
            if(!n) return alert("昵称不能为空");
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(NETWORKS[currentChainId].proxy, V6_ABI, await provider.getSigner());
                await (await contract.register(n)).wait();
                alert("注册成功！");
                window.location.reload();
            } catch(e) { alert("注册失败: " + e.message); }
        }

        async function handleDelete(netId, postId) {
            if(!confirm("确定要删除吗？")) return;
            if(currentChainId !== netId) return alert("请切换网络");
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(NETWORKS[netId].proxy, V6_ABI, await provider.getSigner());
                await (await contract.deletePost(postId)).wait();
                alert("删除成功");
                goBack();
            } catch(e) { alert("删除失败"); }
        }
        
        async function handleBan(status) {
            const addr = document.getElementById('targetAddr').value;
            if(!ethers.isAddress(addr)) return alert("地址无效");
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(NETWORKS[currentChainId].proxy, V6_ABI, await provider.getSigner());
                await (await contract.setBannedStatus(addr, status)).wait();
                alert("操作成功");
                loadAdmin();
            } catch(e) { alert("无权限或网络错误"); }
        }

        // --- 基础连接逻辑 ---
        async function connect() {
            if (!window.ethereum) return alert("请安装 MetaMask");
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                userAddr = await signer.getAddress();
                const net = await provider.getNetwork();
                currentChainId = "0x" + net.chainId.toString(16).toLowerCase();
                updateUI();
                checkNetStatus();
            } catch(e) { console.error(e); }
        }
        
        function updateUI() {
            document.getElementById('connectBtn').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('nav-history').classList.remove('hidden');
            document.getElementById('netSwitcher').value = currentChainId;
        }

        function checkNetStatus() {
            const net = NETWORKS[currentChainId];
            const alertEl = document.getElementById('netAlert');
            const v6Fields = document.getElementById('v6-fields');
            
            if (net) {
                syncUserStatus(net);
                if (currentChainId === '0xa5bd') {
                    alertEl.className = "mb-4 p-4 rounded-xl text-center text-xs font-black bg-pink-50 text-pink-600 border border-pink-200";
                    alertEl.innerHTML = `当前接入 V6 网络：${net.name}`;
                    v6Fields.classList.remove('hidden');
                } else {
                    alertEl.className = "mb-4 p-4 rounded-xl text-center text-xs font-black bg-indigo-50 text-indigo-600 border border-indigo-200";
                    alertEl.innerHTML = `当前接入网络：${net.name}`;
                    v6Fields.classList.add('hidden');
                }
            } else {
                alertEl.className = "mb-4 p-4 rounded-xl text-center text-xs font-black bg-slate-100 text-slate-500";
                alertEl.innerHTML = "请切换至支持的网络";
            }
        }

        async function syncUserStatus(net) {
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(net.proxy, V6_ABI, await provider.getSigner());
                const user = await contract.users(userAddr);
                const owner = await contract.owner();
                document.getElementById('userName').innerText = user.isRegistered ? "@" + user.username : "未注册";
                document.getElementById('userAvatar').innerText = user.isRegistered ? user.username[0].toUpperCase() : '?';
                document.getElementById('regArea').classList.toggle('hidden', user.isRegistered);
                document.getElementById('createArea').classList.toggle('hidden', !user.isRegistered);
                document.getElementById('nav-admin').classList.toggle('hidden', userAddr.toLowerCase() !== owner.toLowerCase());
            } catch(e) {}
        }

        function renderNetworkSwitcher() {
            let html = '<option value="">切换网络...</option>';
            for(let id in NETWORKS) html += `<option value="${id}">${NETWORKS[id].name}</option>`;
            document.getElementById('netSwitcher').innerHTML = html;
        }

        async function switchNetwork(id) {
            if (!id) return;
            try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: id }] }); }
            catch(e) { if(e.code === 4902) {
                const net = NETWORKS[id];
                await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: id, chainName: net.name, rpcUrls: [net.rpc] }] });
            }}
        }

        function goBack() { if(lastView==='post') showView('gallery'); else showView(lastView); }
        function goHome() { showView('dashboard'); }
    </script>
</body>
</html>
