<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo OS v3 | é«˜æ€§èƒ½é“¾ä¸Šä¿¡æ¯ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .view-section { display: none; }
        .view-active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-link-active { background: #4f46e5; color: white !important; }
        .share-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 12px 24px; border-radius: 12px; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .prose img { border-radius: 1rem; margin: 1.5rem auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-height: 500px; object-fit: contain; border: 4px solid white; }
        .pagination-btn { background: white; border: 1px solid #e2e8f0; color: #475569; padding: 8px 16px; border-radius: 12px; font-weight: 700; font-size: 14px; transition: all 0.2s; }
        .pagination-btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .pagination-btn:disabled { background: #f8fafc; color: #94a3b8; cursor: not-allowed; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">

    <div id="toast" class="share-toast font-bold">âœ… é“¾æ¥å·²å¤åˆ¶ï¼</div>

    <nav class="bg-white border-b sticky top-0 z-50 px-6 py-3">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-black shadow-lg shadow-indigo-100">T</div>
                <span class="font-black text-xl tracking-tight">Tempo OS v3</span>
            </div>

            <div id="navMenu" class="flex items-center bg-slate-100 p-1 rounded-2xl flex-wrap justify-center">
                <button onclick="goHome()" id="nav-dashboard" class="px-5 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-indigo-600 transition">é¦–é¡µå¤§å…</button>
                <button onclick="showView('create')" id="nav-create" class="px-5 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-indigo-600 transition">å‘å¸ƒå­˜è¯</button>
                <button onclick="showView('history')" id="nav-history" class="hidden px-5 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-indigo-600 transition">æˆ‘çš„è®°å½•</button>
                <button onclick="showView('admin')" id="nav-admin" class="hidden px-5 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-indigo-600 transition">å°ç¦ç”¨æˆ·</button>
                <button onclick="showView('users')" id="nav-users" class="hidden px-5 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-indigo-600 transition">ç”¨æˆ·åˆ—è¡¨</button>
            </div>

            <div id="authStatus">
                <button id="connectBtn" onclick="connect()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-indigo-700 shadow-md transition">è¿æ¥é’±åŒ…</button>
                <div id="userInfo" class="hidden flex items-center gap-3 bg-white border p-1 pr-4 rounded-2xl shadow-sm">
                    <div id="userAvatar" class="w-8 h-8 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">?</div>
                    <div class="text-left leading-none">
                        <p id="userName" class="text-xs font-black text-indigo-600 mb-1"></p>
                        <p id="userAddr" class="text-[9px] font-mono text-slate-400"></p>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto max-w-4xl px-4 py-10">
        <!-- è§†å›¾ï¼šé¦–é¡µ -->
        <div id="view-dashboard" class="view-section space-y-8">
            <div class="flex justify-between items-end border-b pb-4"><h2 class="text-2xl font-black text-slate-800">å…¨ç½‘æœ€æ–°å­˜è¯</h2><button onclick="loadGlobalFeed(1)" class="text-xs font-bold text-indigo-600 hover:underline">åˆ·æ–°</button></div>
            <div id="globalFeed" class="grid gap-6"></div>
            <div id="dashboard-pagination" class="flex justify-center gap-4 mt-8"></div>
        </div>

        <!-- è§†å›¾ï¼šåˆ›å»º/æ³¨å†Œ -->
        <div id="view-create" class="view-section">
            <div id="regArea" class="hidden bg-indigo-600 rounded-[2.5rem] p-10 text-white shadow-2xl mb-8">
                <h2 class="text-3xl font-black mb-3">æ¿€æ´»èº«ä»½</h2>
                <input type="text" id="regInput" placeholder="è¾“å…¥æ˜µç§°..." class="w-full p-5 rounded-2xl text-slate-900 font-bold mb-4 outline-none"><button onclick="handleRegister()" class="w-full bg-white text-indigo-600 py-5 rounded-2xl font-black">æ³¨å†Œ</button>
            </div>
            <div id="createArea" class="bg-white rounded-[2.5rem] border p-10 shadow-sm">
                <h3 class="text-2xl font-black mb-8 text-slate-800">æ’°å†™å­˜è¯</h3>
                <input type="text" id="postTitle" placeholder="æ ‡é¢˜..." class="w-full p-5 rounded-2xl bg-slate-50 border-none ring-1 ring-slate-100 mb-4 font-bold outline-none">
                <textarea id="postContent" placeholder="å†…å®¹... æ”¯æŒ Markdown" class="w-full p-5 rounded-2xl bg-slate-50 border-none ring-1 ring-slate-100 h-64 font-medium mb-4 outline-none"></textarea>
                <div id="loginNotice" class="text-center py-6 border border-dashed text-slate-400 font-bold mb-4">è¯·å…ˆè¿æ¥é’±åŒ…</div>
                <button id="postBtn" onclick="handlePost()" class="hidden w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xl hover:bg-indigo-600 transition shadow-xl">å‘å¸ƒåˆ°åŒºå—é“¾</button>
            </div>
        </div>

        <!-- è§†å›¾ï¼šå¸–å­è¯¦æƒ… -->
        <div id="view-post" class="view-section">
            <div id="singlePostContainer" class="bg-white rounded-[3rem] border p-8 md:p-12 shadow-sm"></div>
            <div class="text-center mt-10"><button onclick="goHome()" class="text-slate-400 font-bold hover:text-indigo-600">â† è¿”å›å¤§å…</button></div>
        </div>
        
        <!-- è§†å›¾ï¼šæˆ‘çš„è®°å½• -->
        <div id="view-history" class="view-section space-y-6">
            <h2 class="text-2xl font-black text-slate-800 border-b pb-4">æˆ‘çš„ä¸ªäººå­˜è¯</h2>
            <div id="historyList" class="space-y-4"></div>
        </div>

        <!-- è§†å›¾ï¼šç®¡ç†å‘˜å°ç¦ -->
        <div id="view-admin" class="view-section">
            <div class="bg-amber-50 border border-amber-100 rounded-3xl p-8">
                <h2 class="text-2xl font-black text-amber-900 mb-4">ç®¡ç†ç”¨æˆ·çŠ¶æ€</h2>
                <div class="flex gap-3"><input type="text" id="adminTargetAddr" placeholder="0x..." class="flex-1 p-4 rounded-xl ring-1 ring-slate-200 outline-none"><button onclick="handleBan(true)" class="bg-rose-500 text-white px-6 py-4 rounded-xl font-bold">å°ç¦</button><button onclick="handleBan(false)" class="bg-emerald-500 text-white px-6 py-4 rounded-xl font-bold">è§£å°</button></div>
            </div>
        </div>

        <!-- è§†å›¾ï¼šç®¡ç†å‘˜ç”¨æˆ·åˆ—è¡¨ -->
        <div id="view-users" class="view-section space-y-8">
            <h2 class="text-2xl font-black text-slate-800 border-b pb-4">æ³¨å†Œç”¨æˆ·åˆ—è¡¨</h2>
            <div id="userListContainer" class="bg-white border rounded-[2rem] p-6"></div>
            <div id="users-pagination" class="flex justify-center gap-4 mt-8"></div>
        </div>
    </main>

    <!-- ä¿®æ”¹æ¨¡æ€æ¡† -->
    <div id="editModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-white rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="text-2xl font-black mb-6">ä¿®æ”¹å­˜è¯å†…å®¹</h3>
            <input type="hidden" id="editId">
            <input type="text" id="editTitle" class="w-full p-4 rounded-2xl bg-slate-50 font-bold ring-1 ring-slate-200 mb-4 outline-none">
            <textarea id="editContent" class="w-full p-4 rounded-2xl bg-slate-50 h-48 ring-1 ring-slate-200 mb-6 outline-none"></textarea>
            <div class="flex justify-end gap-3"><button onclick="closeEdit()" class="px-4 font-bold text-slate-400">å–æ¶ˆ</button><button id="updateBtn" onclick="submitUpdate()" class="bg-indigo-600 text-white px-10 py-3 rounded-2xl font-black">åŒæ­¥æ›´æ–°</button></div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDR = "0xE6e4226748a175f5f8bf3f141d14b503306fA388";
        const RPC_URL = "https://rpc.testnet.tempo.xyz";
        const ABI = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_title",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_content",
				"type": "string"
			}
		],
		"name": "createPost",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_id",
				"type": "uint256"
			}
		],
		"name": "deletePost",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "postId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "author",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "title",
				"type": "string"
			}
		],
		"name": "PostCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "postId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "deletedBy",
				"type": "address"
			}
		],
		"name": "PostDeleted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "postId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "newTitle",
				"type": "string"
			}
		],
		"name": "PostUpdated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_username",
				"type": "string"
			}
		],
		"name": "register",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_userAddress",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "_status",
				"type": "bool"
			}
		],
		"name": "setBannedStatus",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "_newTitle",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_newContent",
				"type": "string"
			}
		],
		"name": "updatePost",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "isBanned",
				"type": "bool"
			}
		],
		"name": "UserBannedStatusChanged",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "username",
				"type": "string"
			}
		],
		"name": "UserRegistered",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "admin",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "allRegisteredUsers",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_page",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_pageSize",
				"type": "uint256"
			}
		],
		"name": "getPaginatedPosts",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "title",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "content",
						"type": "string"
					},
					{
						"internalType": "address",
						"name": "author",
						"type": "address"
					},
					{
						"internalType": "string",
						"name": "authorName",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "exists",
						"type": "bool"
					}
				],
				"internalType": "struct OnChainInfoSystemV3.Post[]",
				"name": "postsData",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_page",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_pageSize",
				"type": "uint256"
			}
		],
		"name": "getPaginatedUsers",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "username",
						"type": "string"
					},
					{
						"internalType": "bool",
						"name": "isBanned",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "isRegistered",
						"type": "bool"
					},
					{
						"internalType": "address",
						"name": "userAddress",
						"type": "address"
					}
				],
				"internalType": "struct OnChainInfoSystemV3.User[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_id",
				"type": "uint256"
			}
		],
		"name": "getPost",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "title",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "content",
						"type": "string"
					},
					{
						"internalType": "address",
						"name": "author",
						"type": "address"
					},
					{
						"internalType": "string",
						"name": "authorName",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "exists",
						"type": "bool"
					}
				],
				"internalType": "struct OnChainInfoSystemV3.Post",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getPostCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_user",
				"type": "address"
			}
		],
		"name": "getPostIdsByAddress",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_username",
				"type": "string"
			}
		],
		"name": "getPostIdsByUsername",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getUserCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "posts",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "title",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "content",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "author",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "authorName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "exists",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "users",
		"outputs": [
			{
				"internalType": "string",
				"name": "username",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "isBanned",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "isRegistered",
				"type": "bool"
			},
			{
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
        let provider, signer, contract, userAddr;
        let currentView = 'dashboard';
        let currentPostPage = 1;
        let currentUserPage = 1;
        const POSTS_PAGE_SIZE = 10;
        const USERS_PAGE_SIZE = 15;

        window.onload = async () => {
            // âœ… å·²ä¿®å¤ï¼šé…ç½® marked.js ä»¥æ”¯æŒè‡ªåŠ¨æ¢è¡Œ
            marked.setOptions({
                breaks: true, // æ ¸å¿ƒï¼šå°† \n æ¸²æŸ“ä¸º <br>
                gfm: true     // æ¨èï¼šå¯ç”¨æ›´é€šç”¨çš„ GitHub Flavored Markdown è¯­æ³•
            });
            
            provider = new ethers.JsonRpcProvider(RPC_URL);
            contract = new ethers.Contract(CONTRACT_ADDR, ABI, provider);
            
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');
            if (postId) {
                showView('post');
                loadSinglePost(postId);
            } else {
                showView('dashboard');
                loadGlobalFeed(1);
            }

            if (window.ethereum) {
                const acc = await window.ethereum.request({ method: 'eth_accounts' });
                if (acc.length > 0) connect();
            }
        };

        async function connect() {
            if (!window.ethereum) return alert("è¯·å…ˆå®‰è£…é’±åŒ…");
            try {
                const webProvider = new ethers.BrowserProvider(window.ethereum);
                signer = await webProvider.getSigner();
                userAddr = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
                await syncAuthState();
                document.getElementById('nav-history').classList.remove('hidden');
                document.getElementById('loginNotice').classList.add('hidden');
                document.getElementById('postBtn').classList.remove('hidden');
            } catch (e) { console.error("è¿æ¥å¼‚å¸¸:", e); }
        }

        async function syncAuthState() {
            const info = await contract.users(userAddr);
            document.getElementById('connectBtn').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userName').innerText = info.isRegistered ? "@" + info.username : "æœªæ³¨å†Œ";
            document.getElementById('userAddr').innerText = `${userAddr.slice(0,6)}...${userAddr.slice(-4)}`;
            
            const firstLetter = info.isRegistered ? info.username.charAt(0).toUpperCase() : '?';
            document.getElementById('userAvatar').innerText = firstLetter;

            if (info.isRegistered) {
                document.getElementById('regArea').classList.add('hidden');
                document.getElementById('createArea').classList.remove('hidden');
            } else {
                document.getElementById('regArea').classList.remove('hidden');
                document.getElementById('createArea').classList.add('hidden');
            }
            
            const adm = await contract.admin();
            if(userAddr.toLowerCase() === adm.toLowerCase()) {
                document.getElementById('nav-admin').classList.remove('hidden');
                document.getElementById('nav-users').classList.remove('hidden');
            }
        }

        // --- ğŸš€ æ–°çš„ã€é«˜æ•ˆçš„é¦–é¡µåŠ è½½å‡½æ•° ---
        async function loadGlobalFeed(page) {
            currentPostPage = page;
            const container = document.getElementById('globalFeed');
            const paginationContainer = document.getElementById('dashboard-pagination');
            container.innerHTML = `<div class="p-10 text-center text-slate-400 animate-pulse">âš¡ï¸ æ­£åœ¨ä»åŒºå—é“¾é«˜é€Ÿç´¢å¼•...</div>`;
            paginationContainer.innerHTML = '';
            
            try {
                const totalPosts = await contract.getPostCount();
                const postsData = await contract.getPaginatedPosts(page, POSTS_PAGE_SIZE);

                let html = "";
                for (const p of postsData) {
                    if (p.exists) {
                        html += renderCard(p, true);
                    }
                }
                container.innerHTML = html || `<div class="p-20 text-center text-slate-300 italic">é“¾ä¸Šæš‚æ— å†…å®¹</div>`;
                
                // æ¸²æŸ“åˆ†é¡µ
                renderPagination(paginationContainer, page, totalPosts, POSTS_PAGE_SIZE, loadGlobalFeed);

            } catch(e) { 
                console.error("åŠ è½½é¦–é¡µå¤±è´¥:", e);
                container.innerHTML = `<div class="p-10 text-center text-rose-500">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é‡è¯•ã€‚</div>`;
            }
        }

        // --- ğŸš€ æ–°å¢ï¼šåŠ è½½ç”¨æˆ·åˆ—è¡¨å‡½æ•° ---
        async function loadUserList(page) {
            currentUserPage = page;
            const container = document.getElementById('userListContainer');
            const paginationContainer = document.getElementById('users-pagination');
            container.innerHTML = `<div class="p-6 text-center text-slate-400 animate-pulse">æ­£åœ¨è¯»å–ç”¨æˆ·æ•°æ®...</div>`;
            paginationContainer.innerHTML = '';

            try {
                const totalUsers = await contract.getUserCount();
                const usersData = await contract.getPaginatedUsers(page, USERS_PAGE_SIZE);

                let tableHtml = `
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">ç”¨æˆ·å</th>
                                <th scope="col" class="px-6 py-3">åœ°å€</th>
                                <th scope="col" class="px-6 py-3">çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for(const user of usersData) {
                    tableHtml += `
                        <tr class="bg-white border-b hover:bg-slate-50">
                            <th scope="row" class="px-6 py-4 font-bold text-indigo-600">@${user.username}</th>
                            <td class="px-6 py-4 font-mono text-xs">${user.userAddress}</td>
                            <td class="px-6 py-4">${user.isBanned ? '<span class="bg-rose-100 text-rose-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">å·²å°ç¦</span>' : '<span class="bg-emerald-100 text-emerald-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">æ­£å¸¸</span>'}</td>
                        </tr>
                    `;
                }

                tableHtml += '</tbody></table>';
                container.innerHTML = usersData.length > 0 ? tableHtml : `<div class="p-10 text-center text-slate-400">æš‚æ— æ³¨å†Œç”¨æˆ·</div>`;
                
                renderPagination(paginationContainer, page, totalUsers, USERS_PAGE_SIZE, loadUserList);

            } catch (e) {
                console.error("åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:", e);
                container.innerHTML = `<div class="p-10 text-center text-rose-500">åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿æ‚¨æ˜¯ç®¡ç†å‘˜ã€‚</div>`;
            }
        }
        
        function renderPagination(container, currentPage, totalItems, pageSize, callback) {
            const totalPages = Math.ceil(Number(totalItems) / pageSize);
            if (totalPages <= 1) return;

            let paginationHtml = '';
            // ä¸Šä¸€é¡µæŒ‰é’®
            paginationHtml += `<button onclick="${callback.name}(${currentPage - 1})" class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''}>&larr; ä¸Šä¸€é¡µ</button>`;

            // é¡µé¢ä¿¡æ¯
            paginationHtml += `<span class="self-center text-sm text-slate-500">ç¬¬ ${currentPage} / ${totalPages} é¡µ</span>`;

            // ä¸‹ä¸€é¡µæŒ‰é’®
            paginationHtml += `<button onclick="${callback.name}(${currentPage + 1})" class="pagination-btn" ${currentPage >= totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ &rarr;</button>`;

            container.innerHTML = paginationHtml;
        }

        async function loadMyHistory() {
            const container = document.getElementById('historyList');
            if (!userAddr) return;
            container.innerHTML = `<p class="p-10 text-center text-indigo-500 animate-pulse">æ­£åœ¨è¯»å–æ‚¨çš„é“¾ä¸Šå­˜è¯...</p>`;
            try {
                const rawIds = await contract.getPostIdsByAddress(userAddr);
                const ids = Array.from(rawIds).map(Number).reverse();
                if(ids.length === 0) {
                    container.innerHTML = `<p class="p-20 text-center text-slate-300">æ— è®°å½•</p>`;
                    return;
                }
                let html = "";
                for (let id of ids) {
                    const p = await contract.getPost(id);
                    if (p.exists) html += renderCard(p, false);
                }
                container.innerHTML = html || `<p class="p-20 text-center text-slate-300">æ— è®°å½•</p>`;
            } catch (e) { container.innerHTML = "ç´¢å¼•é”™è¯¯ï¼Œè¯·ç¡®ä¿å·²è¿æ¥ Tempo æµ‹è¯•ç½‘"; }
        }

        async function loadSinglePost(id) {
            const container = document.getElementById('singlePostContainer');
            container.innerHTML = `<div class="p-10 text-center text-slate-400 animate-pulse">è§£æå­˜è¯ä¸­...</div>`;
            try {
                const p = await contract.getPost(id);
                if (!p.exists) { container.innerHTML = "å†…å®¹å·²æŠ¹é™¤æˆ–ä¸å­˜åœ¨ã€‚"; return; }
                const renderedContent = marked.parse(p.content);
                container.innerHTML = `
                    <div class="flex justify-between mb-8"><span class="bg-indigo-600 text-white px-4 py-1 rounded-full text-[10px] font-black uppercase">ID #${p.id}</span><button onclick="copyLink(${p.id})" class="text-slate-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6a3 3 0 100-2.684m0 2.684l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg></button></div>
                    <h1 class="text-4xl font-black mb-6">${p.title}</h1>
                    <div class="prose max-w-none text-slate-700 mb-12">${renderedContent}</div>
                    <div class="border-t pt-8 flex justify-between text-xs"><div>ä½œè€…ï¼š<span class="text-indigo-600 font-bold">@${p.authorName}</span></div><div class="text-slate-400">${new Date(Number(p.timestamp)*1000).toLocaleString()}</div></div>
                `;
            } catch (e) { container.innerHTML = "åŠ è½½å¤±è´¥"; }
        }
        
        function renderCard(p, isFeed) {
            const isMine = userAddr && p.author.toLowerCase() === userAddr.toLowerCase();
            const id = Number(p.id);
            return `<div class="bg-white border rounded-[2rem] p-8 hover:shadow-lg transition">
                <div class="flex justify-between items-start mb-4"><span class="text-[10px] font-black bg-slate-100 text-slate-400 px-3 py-1 rounded-full">#${id}</span></div>
                <h3 class="text-2xl font-black mb-2">${p.title}</h3>
                <div class="flex justify-between items-center border-t pt-6 mt-4">
                    <span class="text-xs font-black text-indigo-500">@${p.authorName}</span>
                    <div class="flex gap-4">
                        <button onclick="goDetail(${id})" class="text-sm font-black text-indigo-600 hover:underline">æŸ¥çœ‹</button>
                        ${isMine ? `<button onclick="openEdit(${id})" class="text-sm font-black text-slate-700 hover:underline">ç¼–è¾‘</button><button onclick="handleDelete(${id})" class="text-sm font-black text-rose-400">åˆ é™¤</button>` : ''}
                    </div>
                </div>
            </div>`;
        }
        
        async function openEdit(id) {
            document.getElementById('editId').value = id;
            try {
                const p = await contract.getPost(id);
                document.getElementById('editTitle').value = p.title;
                document.getElementById('editContent').value = p.content;
                document.getElementById('editModal').classList.remove('hidden');
            } catch (e) { alert("è·å–æ•°æ®å¤±è´¥"); }
        }

        function closeEdit() { document.getElementById('editModal').classList.add('hidden'); }

        async function submitUpdate() {
            const id = document.getElementById('editId').value;
            const t = document.getElementById('editTitle').value;
            const c = document.getElementById('editContent').value;
            const btn = document.getElementById('updateBtn');
            btn.disabled = true; btn.innerText = "åŒæ­¥ä¸­...";
            try {
                const tx = await contract.updatePost(id, t, c);
                await tx.wait();
                alert("ä¿®æ”¹æˆåŠŸï¼"); closeEdit(); 
                if(currentView === 'history') loadMyHistory();
                if(currentView === 'dashboard') loadGlobalFeed(currentPostPage);
            } catch (e) { alert("ä¿®æ”¹å¤±è´¥"); }
            finally { btn.disabled = false; btn.innerText = "åŒæ­¥æ›´æ–°"; }
        }

        function goHome() { window.history.pushState({}, '', window.location.pathname); showView('dashboard'); loadGlobalFeed(1); }
        function goDetail(id) { window.history.pushState({}, '', `?id=${id}`); showView('post'); loadSinglePost(id); }
        function copyLink(id) {
            const url = window.location.origin + window.location.pathname + "?id=" + id;
            navigator.clipboard.writeText(url).then(() => {
                const t = document.getElementById('toast');
                t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000);
            });
        }
        
        function showView(viewName) {
            currentView = viewName;
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('view-active'));
            document.querySelectorAll('#navMenu button').forEach(b => b.classList.remove('nav-link-active'));
            document.getElementById(`view-${viewName}`).classList.add('view-active');
            const navBtn = document.getElementById(`nav-${viewName}`);
            if (navBtn) navBtn.classList.add('nav-link-active');
            
            if (viewName === 'history') loadMyHistory();
            if (viewName === 'dashboard') loadGlobalFeed(1);
            if (viewName === 'users') loadUserList(1);
        }

        async function handlePost() {
            const t = document.getElementById('postTitle').value;
            const c = document.getElementById('postContent').value;
            if(!t || !c) return alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º");
            try { const tx = await contract.createPost(t, c); await tx.wait(); goHome(); } catch(e) { alert("å‘å¸ƒå¤±è´¥"); }
        }
        async function handleRegister() {
            const n = document.getElementById('regInput').value;
            if(!n) return alert("æ˜µç§°ä¸èƒ½ä¸ºç©º");
            try { await (await contract.register(n)).wait(); syncAuthState(); } catch(e) { alert("æ³¨å†Œå¤±è´¥ï¼Œå¯èƒ½æ˜¯æ˜µç§°å·²è¢«å ç”¨"); }
        }
        async function handleDelete(id) {
            if(!confirm("ç¡®å®šè¦ä»åŒºå—é“¾ä¸ŠæŠ¹é™¤æ­¤æ¡è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) return;
            try { 
                const tx = await contract.deletePost(id);
                await tx.wait(); 
                alert("åˆ é™¤æˆåŠŸï¼");
                if(currentView === 'history') loadMyHistory();
                if(currentView === 'dashboard') loadGlobalFeed(currentPostPage);
            } catch(e) { alert("æ“ä½œå¤±è´¥"); }
        }
        async function handleBan(s) {
            const a = document.getElementById('adminTargetAddr').value;
            if(!a) return alert("è¯·è¾“å…¥ç›®æ ‡åœ°å€");
            const action = s ? 'å°ç¦' : 'è§£å°';
            if(!confirm(`ç¡®å®šè¦${action}åœ°å€ ${a} å—ï¼Ÿ`)) return;
            try { await (await contract.setBannedStatus(a, s)).wait(); alert("æ“ä½œæˆåŠŸ"); } catch(e) { alert("æƒé™ä¸è¶³æˆ–æ“ä½œå¤±è´¥"); }
        }
    </script>
</body>
</html>
